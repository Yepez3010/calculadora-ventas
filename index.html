<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Cotizador Pro</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007AFF">

<style>
:root{
  --bg:#f4f6fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
  --line:rgba(15,23,42,.10); --primary:#007AFF; --primary2:#2D5BFF;
  --success:#22c55e; --danger:#ef4444; --shadow:0 18px 50px rgba(2,6,23,.10);
  --radius:18px; --radius2:14px;
}
body.dark{
  --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
  --line:rgba(148,163,184,.18); --shadow:0 20px 70px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial;
  background:
    radial-gradient(1000px 600px at 10% -10%, rgba(0,122,255,.20), transparent 55%),
    radial-gradient(900px 500px at 110% 10%, rgba(34,197,94,.14), transparent 55%),
    var(--bg);
  color:var(--text);
}
.container{max-width:1120px;margin:0 auto;padding:18px 14px 80px;}
header{
  position:sticky;top:0;z-index:20;backdrop-filter:blur(10px);
  background:color-mix(in srgb, var(--bg) 75%, transparent);
  border-bottom:1px solid var(--line);
}
.header-inner{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:14px 14px;max-width:1120px;margin:0 auto;
}
.brand{display:flex;align-items:center;gap:10px;}
.logo{
  width:42px;height:42px;border-radius:14px;
  background:linear-gradient(135deg,var(--primary),var(--primary2));
  display:grid;place-items:center;color:white;font-weight:800;
  box-shadow:0 10px 30px rgba(0,122,255,.35);
}
.brand h1{margin:0;font-size:18px;letter-spacing:.2px;}
.brand .sub{font-size:12px;color:var(--muted);margin-top:2px;}
.header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.icon-btn{
  border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 88%, transparent);
  color:var(--text);
  padding:10px 12px;border-radius:14px;cursor:pointer;
  box-shadow:0 10px 24px rgba(2,6,23,.06);
  transition:.18s ease;display:flex;gap:8px;align-items:center;font-weight:700;
}
.icon-btn:hover{transform:translateY(-1px)}
.icon{font-size:16px}

.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px;}
@media (max-width:980px){.grid{grid-template-columns:1fr}}

.card{
  background:color-mix(in srgb, var(--card) 92%, transparent);
  border:1px solid var(--line);border-radius:var(--radius);
  box-shadow:var(--shadow);overflow:hidden;
}
.card .head{
  padding:14px 16px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--line);
}
.card .head h2{margin:0;font-size:15px;letter-spacing:.2px}
.card .content{padding:14px 16px 16px}

.row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media (max-width:520px){.row{grid-template-columns:1fr}}

.field label{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin:2px 0 6px;}
.input,select,textarea{
  width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 92%, transparent);
  color:var(--text);outline:none;transition:.15s ease;font-family:inherit;
}
textarea{min-height:84px;resize:vertical}
.input:focus,select:focus,textarea:focus{
  border-color:color-mix(in srgb, var(--primary) 55%, var(--line));
  box-shadow:0 0 0 4px rgba(0,122,255,.15);
}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
.btn{
  border:none;border-radius:14px;padding:12px 14px;cursor:pointer;font-weight:800;
  display:flex;gap:10px;align-items:center;transition:.18s ease;
}
.btn-primary{color:white;background:linear-gradient(135deg,var(--primary),var(--primary2));box-shadow:0 14px 30px rgba(0,122,255,.35);}
.btn-primary:hover{transform:translateY(-1px)}
.btn-soft{
  color:var(--text);
  background:color-mix(in srgb, var(--primary) 10%, var(--card));
  border:1px solid color-mix(in srgb, var(--primary) 25%, var(--line));
}
.btn-muted{color:var(--text);background:color-mix(in srgb, var(--card) 92%, transparent);border:1px solid var(--line);}
.btn-danger{color:white;background:linear-gradient(135deg,#ef4444,#fb7185);box-shadow:0 14px 30px rgba(239,68,68,.25);}
.btn-danger:hover{transform:translateY(-1px)}
.btn:disabled{opacity:.6;cursor:not-allowed}

.badge{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);}
hr.sep{border:none;border-top:1px dashed var(--line);margin:14px 0;}
.muted{color:var(--muted);font-size:13px;}
.small{font-size:12px;color:var(--muted);}

.item-line{display:grid;grid-template-columns:.95fr .65fr .85fr .85fr auto;gap:10px;align-items:end;}
@media (max-width:780px){.item-line{grid-template-columns:1fr 1fr}}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.chip{
  display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
  border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 92%, transparent);
  font-size:12px;
}
.chip b{font-size:12px}
.chip .x{
  width:22px;height:22px;border-radius:999px;display:grid;place-items:center;cursor:pointer;
  border:1px solid var(--line);
  background:color-mix(in srgb, #ef4444 10%, var(--card));
}
.results{padding:14px 16px}
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
@media (max-width:520px){.kpis{grid-template-columns:1fr}}
.kpi{
  border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 92%, transparent);
  border-radius:var(--radius2);padding:12px;
}
.kpi .t{font-size:12px;color:var(--muted)}
.kpi .v{font-size:18px;font-weight:900;margin-top:4px}

.table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px;}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;}
.table th{color:var(--muted);font-weight:800;font-size:12px;}

details.private{
  border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;margin-top:14px;
  background:color-mix(in srgb, var(--card) 92%, transparent);
}
details.private summary{
  list-style:none;cursor:pointer;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;
  gap:10px;font-weight:900;border-bottom:1px solid var(--line);
}
details.private summary::-webkit-details-marker{display:none}

.calcbox{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media (max-width:700px){.calcbox{grid-template-columns:1fr}}
.mini{
  border:1px solid var(--line);border-radius:var(--radius2);padding:12px;
  background:color-mix(in srgb, var(--card) 92%, transparent);
}
.mini h3{margin:0 0 8px;font-size:13px;}
.mini .mini-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.mini .mini-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
.mini .mini-out{
  margin-top:10px;font-weight:900;padding:10px;border-radius:12px;border:1px solid var(--line);
  background:color-mix(in srgb, var(--success) 10%, var(--card));
}

.history-list{display:flex;flex-direction:column;gap:10px;}
.hist{border:1px solid var(--line);background:color-mix(in srgb, var(--card) 92%, transparent);border-radius:var(--radius2);padding:12px;}
.hist-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
.hist-top b{font-size:13px;}
.hist-top .meta{font-size:12px;color:var(--muted);}
.hist-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
.hist-actions button{
  padding:9px 10px;border-radius:12px;border:1px solid var(--line);
  background:color-mix(in srgb, var(--primary) 10%, var(--card));
  cursor:pointer;font-weight:800;
}
.hist-actions .del{background:color-mix(in srgb, #ef4444 12%, var(--card));}

body.client .admin-only{display:none!important;}
body.client .grid{grid-template-columns:1fr;}
body.client .card{max-width:980px;margin:0 auto;}

/* ===========================
   LOGIN OVERLAY (ELEGANTE)
   =========================== */
#loginOverlay{
  position:fixed; inset:0; z-index:9999;
  display:none;
  place-items:center;
  padding:18px;
  background: radial-gradient(1000px 600px at 10% -10%, rgba(0,122,255,.25), transparent 55%),
              radial-gradient(900px 500px at 110% 10%, rgba(34,197,94,.18), transparent 55%),
              rgba(2,6,23,.55);
  backdrop-filter: blur(10px);
}
#loginOverlay.show{ display:grid; }

.login-card{
  width:min(520px, 100%);
  border-radius:22px;
  border:1px solid color-mix(in srgb, var(--line) 65%, transparent);
  background:color-mix(in srgb, var(--card) 92%, transparent);
  box-shadow: 0 30px 90px rgba(0,0,0,.35);
  overflow:hidden;
}
.login-head{
  padding:16px 16px 12px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  border-bottom:1px solid var(--line);
}
.login-title{
  display:flex; align-items:center; gap:10px;
}
.login-title .badge2{
  width:44px; height:44px; border-radius:16px;
  display:grid; place-items:center;
  background:linear-gradient(135deg,var(--primary),var(--primary2));
  color:#fff; font-weight:900;
  box-shadow:0 10px 30px rgba(0,122,255,.35);
}
.login-title h3{margin:0; font-size:15px;}
.login-title .p{margin:2px 0 0; font-size:12px; color:var(--muted);}
.login-body{ padding:14px 16px 16px; }
.login-actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
.login-hint{
  margin-top:10px;
  font-size:12px; color:var(--muted);
  border-top:1px dashed var(--line);
  padding-top:10px;
}
.pill{
  display:inline-flex; align-items:center; gap:6px;
  border:1px solid var(--line);
  padding:6px 10px;
  border-radius:999px;
  font-weight:800;
  background:color-mix(in srgb, var(--card) 92%, transparent);
}
</style>
</head>

<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" aria-hidden="true">
  <div class="login-card">
    <div class="login-head">
      <div class="login-title">
        <div class="badge2">CP</div>
        <div>
          <h3>Acceso ‚Ä¢ Cotizador Pro</h3>
          <div class="p">Inicia sesi√≥n para usar tu espacio de trabajo</div>
        </div>
      </div>
      <span class="pill" id="loginStatus">üîí Protegido</span>
    </div>

    <div class="login-body">
      <div class="row">
        <div class="field">
          <label>Usuario</label>
          <select id="loginUser" class="input">
            <option value="admin">admin</option>
            <option value="usuario">usuario</option>
          </select>
        </div>
        <div class="field">
          <label>Contrase√±a</label>
          <input class="input" id="loginPass" type="password" placeholder="Tu contrase√±a" autocomplete="current-password" />
        </div>
      </div>

      <div class="login-actions">
        <button class="btn btn-primary" id="loginBtn">üîë Entrar</button>
        <button class="btn btn-muted" id="loginClearBtn" type="button">üßπ Limpiar</button>
      </div>

      <div class="login-hint">
        <div><b>Tip:</b> Cada usuario tiene su <b>historial y borrador</b> separados (no se pisan).</div>
      </div>
    </div>
  </div>
</div>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">CP</div>
      <div>
        <h1 id="brandTitle">Cotizador Pro</h1>
        <div class="sub">Cotiza r√°pido ‚Ä¢ PDF ‚Ä¢ WhatsApp ‚Ä¢ Historial</div>
      </div>
    </div>
    <div class="header-actions">
      <span class="badge" id="activeUserBadge" title="Usuario activo">‚Äî</span>
      <button class="icon-btn" id="logoutBtn" title="Cerrar sesi√≥n"><span class="icon">üö™</span> Salir</button>
      <button class="icon-btn" id="clientModeBtn" title="Alternar Modo Cliente"><span class="icon">üë§</span> Modo Cliente</button>
      <button class="icon-btn" id="themeToggle" title="Modo claro/oscuro"><span class="icon">üåô</span></button>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="head">
        <h2>Datos de la cotizaci√≥n</h2>
        <span class="badge" id="rateState">Tasa manual</span>
      </div>
      <div class="content">
        <div class="row">
          <div class="field">
            <label>Cliente</label>
            <input class="input" id="client" placeholder="Nombre del cliente" />
          </div>
          <div class="field">
            <label>Fecha</label>
            <input class="input" id="date" type="date" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Tienda</label>
            <select id="brand" class="input">
              <option value="">Selecciona‚Ä¶</option>
              <option value="Shein">Shein</option>
              <option value="Temu">Temu</option>
              <option value="AliExpress">AliExpress</option>
            </select>
          </div>
          <div class="field">
            <label>
              Tasa BCV (USD‚ÜíVES)
              <span class="small"><button class="icon-btn" id="rateBtn" style="padding:6px 10px;border-radius:12px;font-weight:800">‚Üª Actualizar</button></span>
            </label>
            <input class="input" id="bcv" type="number" step="0.01" placeholder="Ej: 38.50" />
          </div>
        </div>

        <hr class="sep">

        <div class="item-line admin-only">
          <div class="field">
            <label>Art√≠culos/Servicios</label>
            <select id="itemType" class="input">
              <option value="Ropa">Ropa</option>
              <option value="Accesorios">Accesorios</option>
              <option value="Otros">Otros</option>
            </select>
          </div>

          <div class="field">
            <label>Cantidad</label>
            <input class="input" id="itemQty" type="number" step="1" min="0" placeholder="0" />
          </div>

          <div class="field">
            <label>Precio (USD)</label>
            <input class="input" id="itemPrice" type="number" step="0.01" min="0" placeholder="Ej: 100 USD" />
          </div>

          <div class="field">
            <label>Impuesto ($)</label>
            <input class="input" id="itemTax" type="number" step="0.01" min="0" placeholder="0.00" />
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <button class="btn btn-soft" id="addItemBtn" style="width:100%;justify-content:center">‚ûï Agregar</button>
          </div>
        </div>

        <div class="chips admin-only" id="itemsChips"></div>

        <hr class="sep">

        <div class="row admin-only">
          <div class="field">
            <label>Env√≠o Internacional (%)</label>
            <input class="input" id="shipping" type="number" step="0.01" min="0" placeholder="Ej: 10" />
          </div>

          <div class="field">
            <label>Inicial (%)</label>
            <input class="input" id="initial" type="number" step="0.01" min="0" max="100" placeholder="Ej: 30" />
            <div class="small" id="initialPreview" style="margin-top:6px;">Inicial estimada: ‚Äî</div>
          </div>
        </div>

        <div class="actions admin-only">
          <button class="btn btn-primary" id="calcBtn">üßÆ Calcular</button>
          <button class="btn btn-muted" id="resetBtn">‚ôªÔ∏è Reiniciar</button>
        </div>

        <details class="private admin-only" id="privateDetails">
          <summary>
            <span>üîí Ajustes Privados</span>
            <button class="btn btn-muted" id="privateToggleBtn" type="button" style="padding:8px 10px">Abrir Ajustes Privados</button>
          </summary>
          <div class="content">
            <div class="calcbox">
              <div class="mini">
                <h3>Mini Calculadora 1</h3>
                <div class="mini-row">
                  <div class="field">
                    <label>Monto A</label>
                    <input class="input" id="m1a" type="number" step="0.01">
                  </div>
                  <div class="field">
                    <label>Monto B</label>
                    <input class="input" id="m1b" type="number" step="0.01">
                  </div>
                </div>
                <div class="mini-actions">
                  <button class="btn btn-soft" id="m1plus">‚ûï</button>
                  <button class="btn btn-soft" id="m1minus">‚ûñ</button>
                  <button class="btn btn-soft" id="m1mul">‚úñÔ∏è</button>
                </div>
                <div class="mini-out" id="m1out">0.00</div>
              </div>

              <div class="mini">
                <h3>Mini Calculadora 2 (Bs ‚Üí $ seg√∫n BCV)</h3>
                <div class="mini-row">
                  <div class="field">
                    <label>Monto Bs A</label>
                    <input class="input" id="m2a" type="number" step="0.01" placeholder="0.00">
                  </div>
                  <div class="field">
                    <label>Monto USD B</label>
                    <input class="input" id="m2b" type="number" step="0.01" placeholder="0.00">
                  </div>
                </div>
                <div class="mini-actions">
                  <button class="btn btn-soft" id="m2plus">‚ûï</button>
                  <button class="btn btn-soft" id="m2minus">‚ûñ</button>
                  <button class="btn btn-soft" id="m2mul">‚úñÔ∏è</button>
                </div>
                <div class="mini-out" id="m2out">$0.00</div>
              </div>

              <div class="mini" style="grid-column:1 / -1;">
                <h3>M√©todos de pago (se env√≠an por WhatsApp)</h3>
                <div class="row">
                  <div class="field">
                    <label>Bol√≠vares (Bs)</label>
                    <textarea id="pay_bs" class="input" placeholder="Ej: Pago M√≥vil, Transferencia"></textarea>
                  </div>
                  <div class="field">
                    <label>D√≥lares (USD)</label>
                    <textarea id="pay_usd" class="input" placeholder="Ej: Efectivo, Zinli, Wally"></textarea>
                  </div>
                </div>
                <div class="row">
                  <div class="field">
                    <label>Pesos Colombianos (COP)</label>
                    <textarea id="pay_cop" class="input" placeholder="Ej: Bancolombia, Nequi, Nu"></textarea>
                  </div>
                  <div class="field">
                    <label>USDT</label>
                    <textarea id="pay_usdt" class="input" placeholder="Ej: Binance Pay"></textarea>
                  </div>
                </div>
                <div class="small">Tip: separa m√©todos por coma para que salga limpio en el mensaje.</div>
              </div>

              <div class="mini" style="grid-column:1 / -1;">
                <h3>T√©rminos y condiciones (se env√≠an por WhatsApp)</h3>
                <div class="field">
                  <label>Texto (una condici√≥n por l√≠nea)</label>
                  <textarea id="terms_text" class="input" placeholder="Escribe aqu√≠ tus t√©rminos..."></textarea>
                </div>
                <div class="small">Cada l√≠nea se enviar√° como un punto ‚Ä¢ en WhatsApp.</div>
              </div>

            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card" id="resultsCard">
      <div class="head">
        <h2>Resultado</h2>
        <span class="badge" id="modeBadge">Admin</span>
      </div>

      <details open id="calcDetails">
        <summary class="muted" style="padding:10px 16px; cursor:pointer; border-bottom:1px solid var(--line); list-style:none;">
          Ver / Ocultar detalles
        </summary>
        <div class="results" id="results">
          <div class="muted">Sin cotizaci√≥n todav√≠a.</div>
        </div>
      </details>

      <div class="content">
        <div class="actions" style="margin-top:0">
          <button class="btn btn-soft" id="pdfBtn">üìÑ PDF</button>
          <button class="btn btn-soft" id="waBtn">üì≤ WhatsApp</button>
        </div>

        <hr class="sep">

        <div class="head" style="border:0;padding:0 0 10px">
          <h2>Historial</h2>
          <button class="btn btn-danger admin-only" id="clearHistoryBtn">üóëÔ∏è Borrar</button>
        </div>
        <div class="history-list" id="historyList"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){

  /* ===========================
     AUTH (LOCAL) + MULTI-USUARIO
     =========================== */
  const AUTH = {
    Gustavo:  "0579",
    Alexandra:"2015"
  };
  const ACTIVE_USER_KEY = "cotizador_active_user_v1";

  const $ = (id)=>document.getElementById(id);

  function setActiveUser(u){
    localStorage.setItem(ACTIVE_USER_KEY, u);
    updateActiveUserBadge();
  }
  function getActiveUser(){
    const u = localStorage.getItem(ACTIVE_USER_KEY);
    if(u && (u === "admin" || u === "usuario")) return u;
    return null;
  }
  function updateActiveUserBadge(){
    const u = getActiveUser();
    const el = $("activeUserBadge");
    if(!el) return;
    el.textContent = u ? ("üë§ " + u) : "‚Äî";
  }

  function showLogin(){
    $("loginOverlay").classList.add("show");
    $("loginOverlay").setAttribute("aria-hidden","false");
    $("loginPass").value = "";
    updateActiveUserBadge();
    setTimeout(()=> $("loginPass").focus(), 50);
  }
  function hideLogin(){
    $("loginOverlay").classList.remove("show");
    $("loginOverlay").setAttribute("aria-hidden","true");
  }

  function doLogin(){
    const user = $("loginUser").value;
    const pass = $("loginPass").value;
    if(!AUTH[user] || pass !== AUTH[user]){
      $("loginStatus").textContent = "‚ùå Datos incorrectos";
      setTimeout(()=> $("loginStatus").textContent = "üîí Protegido", 1200);
      $("loginPass").focus();
      return;
    }
    setActiveUser(user);
    hideLogin();
    // Re-inicializa la app con el usuario ya establecido:
    boot();
  }

  function doLogout(){
    if(!confirm("¬øCerrar sesi√≥n?")) return;
    localStorage.removeItem(ACTIVE_USER_KEY);
    updateActiveUserBadge();
    // Para evitar que queden datos en pantalla, recargamos:
    location.reload();
  }

  /* ===========================
     APP BOOT (depende del usuario)
     =========================== */
  function boot(){
    const USER = getActiveUser();
    if(!USER){
      showLogin();
      return;
    }

    // Prefijo por usuario: TODO queda separado
    const PFX = `cotizador_${USER}_`;

    const STORAGE = {
      draft:       PFX + "draft_v1",
      history:     PFX + "history_v1",
      theme:       PFX + "theme_v1",
      mode:        PFX + "mode_v1",
      rate:        PFX + "rate_v1",
      rate_last_day:PFX + "rate_day_v1",
      last_quote:  PFX + "last_quote_v1",
      payments:    PFX + "payments_v1",
      terms:       PFX + "terms_v1"
    };

    const DEFAULT_INITIAL_PCT = 30;
    const DEFAULT_TERMS_LINES = [
      "Para realizar tu encargo es obligatorio pagar la inicial.",
      "La tasa y los montos en Bs pueden variar seg√∫n la tasa BCV del momento."
    ].join("\n");

    function safeParse(jsonStr, fallback){ try{ return JSON.parse(jsonStr); }catch(e){ return fallback; } }
    function nowISODate(){
      const d=new Date(); const off=d.getTimezoneOffset();
      const local=new Date(d.getTime()-off*60000);
      return local.toISOString().slice(0,10);
    }
    function nowDateTimeVE(){
      const d=new Date();
      const fecha=d.toLocaleDateString("es-VE",{year:"numeric",month:"2-digit",day:"2-digit"});
      const hora=d.toLocaleTimeString("es-VE",{hour:"2-digit",minute:"2-digit"});
      return `${fecha} ${hora}`;
    }
    function fmt(n){
      const v=Number(n||0);
      return v.toLocaleString("es-VE",{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function fmtPct(n){
      const v=Number(n||0);
      return v.toLocaleString("es-VE",{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function clamp(n,min,max){
      n=Number(n||0);
      return Math.max(min,Math.min(max,n));
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    // Estado
    let items = [];
    let lastQuote = safeParse(localStorage.getItem(STORAGE.last_quote) || "null", null);
    let history = safeParse(localStorage.getItem(STORAGE.history) || "[]", []);
    if(!Array.isArray(history)) history = [];
    if(!(lastQuote && typeof lastQuote==="object" && !Array.isArray(lastQuote))) lastQuote = null;

    // Pagos
    const defaultPayments = {
      bs:"Pago M√≥vil, Transferencia",
      usd:"Efectivo, Zinli, Wally",
      cop:"Bancolombia, Nequi, Nu",
      usdt:"Binance Pay"
    };
    let payments = Object.assign({}, defaultPayments, safeParse(localStorage.getItem(STORAGE.payments) || "null", {}) || {});

    // T√©rminos
    let termsText = (localStorage.getItem(STORAGE.terms) || DEFAULT_TERMS_LINES);

    function applyPaymentsToUI(){
      $("pay_bs").value = payments.bs || "";
      $("pay_usd").value = payments.usd || "";
      $("pay_cop").value = payments.cop || "";
      $("pay_usdt").value = payments.usdt || "";
    }
    function readPaymentsFromUI(){
      payments = {
        bs: ($("pay_bs").value || "").trim(),
        usd: ($("pay_usd").value || "").trim(),
        cop: ($("pay_cop").value || "").trim(),
        usdt: ($("pay_usdt").value || "").trim()
      };
      localStorage.setItem(STORAGE.payments, JSON.stringify(payments));
    }
    function applyTermsToUI(){
      $("terms_text").value = termsText || "";
    }
    function readTermsFromUI(){
      termsText = ($("terms_text").value || "").trim();
      localStorage.setItem(STORAGE.terms, termsText);
    }
    function formatTermsForWA(text){
      const lines = String(text || "").split("\n").map(l=>l.trim()).filter(Boolean);
      if(lines.length === 0) return "‚Ä¢ ‚Äî";
      return lines.map(l=>{
        if(l.startsWith("‚Ä¢")) return l;
        if(l.startsWith("-")) return "‚Ä¢ " + l.slice(1).trim();
        return "‚Ä¢ " + l;
      }).join("\n");
    }

    // UI init
    $("brandTitle").textContent = "Cotizador Pro";
    updateActiveUserBadge();
    if(!$("date").value) $("date").value = nowISODate();

    const savedTheme = localStorage.getItem(STORAGE.theme);
    // Limpia clase previa por si cambiaste de user sin recargar (extra)
    document.body.classList.remove("dark");
    if(savedTheme === "dark"){ document.body.classList.add("dark"); $("themeToggle").textContent = "‚òÄÔ∏è"; }
    else { $("themeToggle").textContent = "üåô"; }

    function updatePrivateToggleText(){
      const d=$("privateDetails"), btn=$("privateToggleBtn");
      if(!d||!btn) return;
      btn.textContent = d.open ? "Cerrar Ajustes Privados" : "Abrir Ajustes Privados";
    }
    function togglePrivateSection(){
      const d=$("privateDetails"); if(!d) return;
      d.open = !d.open; updatePrivateToggleText();
    }
    $("privateDetails").addEventListener("toggle", updatePrivateToggleText);

    $("themeToggle").onclick = ()=>{
      document.body.classList.toggle("dark");
      const isDark=document.body.classList.contains("dark");
      $("themeToggle").textContent=isDark?"‚òÄÔ∏è":"üåô";
      localStorage.setItem(STORAGE.theme, isDark?"dark":"light");
    };

    function ensureDefaultInitialPct(){
      if($("initial").value === "" || $("initial").value == null){
        $("initial").value = String(DEFAULT_INITIAL_PCT);
      }
    }

    function saveDraft(){
      const draft = {
        client:$("client").value.trim(),
        date:$("date").value,
        brand:$("brand").value,
        itemType:$("itemType").value,
        shipping:$("shipping").value,
        initial:$("initial").value, // %
        bcv:$("bcv").value,
        items:items
      };
      localStorage.setItem(STORAGE.draft, JSON.stringify(draft));
    }

    function loadDraft(){
      const raw = localStorage.getItem(STORAGE.draft);
      if(!raw){ ensureDefaultInitialPct(); return; }
      try{
        const d = JSON.parse(raw);
        $("client").value = d.client ?? "";
        $("date").value = d.date ?? nowISODate();
        $("brand").value = d.brand ?? "";
        $("itemType").value = d.itemType ?? "Ropa";
        $("shipping").value = d.shipping ?? "";
        $("initial").value = (d.initial ?? "") !== "" ? d.initial : String(DEFAULT_INITIAL_PCT);
        $("bcv").value = d.bcv ?? "";
        items = Array.isArray(d.items) ? d.items : [];
      }catch(e){
        ensureDefaultInitialPct();
      }
    }

    function updateAddBtn(){
      $("addItemBtn").disabled = !$("brand").value;
    }

    function addItem(){
      const store = $("brand").value;
      const type = $("itemType").value || "Otros";
      const qty = Number($("itemQty").value || 0);
      const price = Number($("itemPrice").value || 0);
      const tax = Number($("itemTax").value || 0);

      if(!store){ alert("Selecciona una Tienda antes de agregar art√≠culos."); $("brand").focus(); return; }
      if(price < 0 || tax < 0 || qty < 0){ alert("Valores inv√°lidos."); return; }

      const name = `${store} ‚Äî ${type}`;
      items.push({ store, type, name, qty, price, tax });

      $("itemQty").value = "";
      $("itemPrice").value = "";
      $("itemTax").value = "";

      renderItemsChips();
      saveDraft();
      updateInitialPreview();
    }

    function removeItem(idx){
      items.splice(idx,1);
      renderItemsChips();
      saveDraft();
      updateInitialPreview();
    }

    function renderItemsChips(){
      const wrap = $("itemsChips");
      wrap.innerHTML = "";
      if(items.length === 0){ wrap.innerHTML = `<div class="muted">No has agregado art√≠culos.</div>`; return; }
      items.forEach((it,i)=>{
        const div=document.createElement("div");
        div.className="chip";
        const qtyTxt = it.qty ? ` ‚Ä¢ Cant: ${it.qty}` : "";
        div.innerHTML = `<b>${escapeHtml(it.name)}</b>${qtyTxt} ‚Ä¢ $${fmt(it.price)} + $${fmt(it.tax)} <span class="x" title="Eliminar">‚úï</span>`;
        div.querySelector(".x").addEventListener("click", ()=>removeItem(i));
        wrap.appendChild(div);
      });
    }

    // Preview solo para inicial
    function getPreviewTotals(){
      const shippingPct = clamp($("shipping").value, 0, 100);
      const initialPct = clamp($("initial").value, 0, 100);
      const bcv = Number($("bcv").value || 0);

      const itemsCalc = items.map(it=>{
        const subtotal = Number(it.price || 0);
        const tax = Number(it.tax || 0);
        const total = subtotal + tax;
        return { ...it, subtotal, tax, total };
      });

      const totalItemsUSD = itemsCalc.reduce((a,b)=>a + b.total, 0);
      const shippingUSD = totalItemsUSD * (shippingPct / 100);
      const totalUSD = totalItemsUSD + shippingUSD;

      const initialUSD = totalUSD * (initialPct / 100);
      const initialBs = bcv ? initialUSD * bcv : 0;

      return { totalItemsUSD, shippingPct, shippingUSD, totalUSD, initialPct, initialUSD, bcv, initialBs };
    }

    function updateInitialPreview(){
      const el = $("initialPreview");
      if(!el) return;

      if(items.length === 0){
        el.textContent = "Inicial estimada: ‚Äî";
        return;
      }

      const p = getPreviewTotals();
      const usdTxt = `$${fmt(p.initialUSD)}`;
      const bsTxt = p.bcv ? ` ‚Ä¢ ${fmt(p.initialBs)} Bs` : "";
      el.textContent = `Inicial estimada (${fmtPct(p.initialPct)}%): ${usdTxt}${bsTxt}`;
    }

    function calculate(){
      if(items.length === 0){ alert("Agrega al menos un art√≠culo."); return; }
      const store = $("brand").value;
      if(!store){ alert("Selecciona una Tienda antes de calcular."); $("brand").focus(); return; }

      const shippingPct = clamp($("shipping").value, 0, 100);
      const initialPct = clamp($("initial").value, 0, 100);
      const bcv = Number($("bcv").value || 0);

      const itemsCalc = items.map(it=>{
        const subtotal = Number(it.price || 0);
        const tax = Number(it.tax || 0);
        const total = subtotal + tax; // no multiplicar por cantidad
        return { ...it, subtotal, tax, total };
      });

      const subtotalUSD = itemsCalc.reduce((a,b)=>a + b.subtotal, 0);
      const taxesUSD = itemsCalc.reduce((a,b)=>a + b.tax, 0);
      const totalItemsUSD = itemsCalc.reduce((a,b)=>a + b.total, 0);

      const shippingUSD = totalItemsUSD * (shippingPct / 100);
      const totalUSD = totalItemsUSD + shippingUSD;

      const initialUSD = totalUSD * (initialPct / 100);
      const remainingUSD = Math.max(0, totalUSD - initialUSD);

      const totalBs = bcv ? totalUSD * bcv : 0;
      const initialBs = bcv ? initialUSD * bcv : 0;
      const remainingBs = bcv ? remainingUSD * bcv : 0;

      const quote = {
        client:$("client").value.trim(),
        date:$("date").value,
        brand:store,
        shippingPct,
        initialPct,
        initialUSD,
        bcv,
        items:itemsCalc,
        subtotalUSD, taxesUSD, totalItemsUSD, shippingUSD, totalUSD,
        remainingUSD,
        totalBs, initialBs, remainingBs
      };

      lastQuote = quote;
      renderResults(quote);

      history.unshift(quote);
      history = history.slice(0, 50);
      localStorage.setItem(STORAGE.history, JSON.stringify(history));
      localStorage.setItem(STORAGE.last_quote, JSON.stringify(lastQuote));
      renderHistory();
      saveDraft();
    }

    function renderResults(q){
      const r = $("results");
      const lines = q.items.map(it=>`
        <tr>
          <td><b>${escapeHtml(it.name)}</b><div class="small">${it.qty ? "Cant: " + it.qty : ""}</div></td>
          <td>$${fmt(it.subtotal)}</td>
          <td>$${fmt(it.tax)}</td>
          <td><b>$${fmt(it.total)}</b></td>
        </tr>
      `).join("");

      const pct = Number(q.initialPct ?? (q.totalUSD > 0 ? (q.initialUSD / q.totalUSD) * 100 : DEFAULT_INITIAL_PCT));

      r.innerHTML = `
        <div class="kpis">
          <div class="kpi">
            <div class="t">Total (USD)</div>
            <div class="v">$${fmt(q.totalUSD)}</div>
          </div>

          <div class="kpi">
            <div class="t">Total (Bs)</div>
            <div class="v">${q.bcv ? fmt(q.totalBs) + " Bs" : "‚Äî"}</div>
          </div>

          <div class="kpi">
            <div class="t">Inicial (%)</div>
            <div class="v">${fmtPct(pct)}%</div>
          </div>

          <div class="kpi">
            <div class="t">Inicial (USD / Bs)</div>
            <div class="v">$${fmt(q.initialUSD)} ${q.bcv ? "‚Ä¢ " + fmt(q.initialBs) + " Bs" : ""}</div>
          </div>

          <div class="kpi">
            <div class="t">Restante (USD)</div>
            <div class="v">$${fmt(q.remainingUSD)}</div>
          </div>
        </div>

        <table class="table">
          <thead><tr><th>Art√≠culo</th><th>Precio</th><th>Impuesto</th><th>Total</th></tr></thead>
          <tbody>${lines}</tbody>
        </table>

        <div class="muted" style="margin-top:12px">
          Subtotal: <b>$${fmt(q.subtotalUSD)}</b> ‚Ä¢ Impuestos: <b>$${fmt(q.taxesUSD)}</b> ‚Ä¢
          Env√≠o Internacional (${fmtPct(q.shippingPct)}%): <b>$${fmt(q.shippingUSD)}</b>
        </div>
      `;
    }

    function renderHistory(){
      const list = $("historyList");
      list.innerHTML = "";
      if(history.length === 0){ list.innerHTML = `<div class="muted">A√∫n no hay cotizaciones guardadas.</div>`; return; }

      history.forEach((q, idx)=>{
        const div = document.createElement("div");
        div.className = "hist";
        div.innerHTML = `
          <div class="hist-top">
            <div>
              <b>${escapeHtml(q.client || "Sin cliente")}</b>
              <div class="meta">${escapeHtml(q.brand || "")} ‚Ä¢ ${q.date || ""}</div>
            </div>
            <div style="font-weight:900">$${fmt(q.totalUSD)}</div>
          </div>
          <div class="hist-actions">
            <button data-act="load">Cargar</button>
            <button data-act="pdf">PDF</button>
            <button data-act="wa">WhatsApp</button>
            <button class="del" data-act="del">Eliminar</button>
          </div>
        `;
        div.querySelectorAll("button").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const act = btn.getAttribute("data-act");
            if(act==="load") loadFromHistory(idx);
            if(act==="pdf") exportPDF(history[idx]);
            if(act==="wa") shareWhatsApp(history[idx]);
            if(act==="del") deleteFromHistory(idx);
          });
        });
        list.appendChild(div);
      });
    }

    function loadFromHistory(index){
      const q = history[index];
      if(!q) return;

      $("client").value = q.client ?? "";
      $("date").value = q.date ?? nowISODate();
      $("brand").value = q.brand ?? "";
      $("shipping").value = q.shippingPct ?? "";

      if(q.initialPct != null){
        $("initial").value = q.initialPct;
      }else{
        const inferred = q.totalUSD > 0 ? (q.initialUSD / q.totalUSD) * 100 : DEFAULT_INITIAL_PCT;
        $("initial").value = String(Math.round(inferred * 100) / 100);
      }

      $("bcv").value = q.bcv ?? "";
      items = Array.isArray(q.items) ? [...q.items] : [];
      renderItemsChips();

      lastQuote = q;
      localStorage.setItem(STORAGE.last_quote, JSON.stringify(lastQuote));
      renderResults(q);
      saveDraft();
      updateAddBtn();
      updateInitialPreview();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function deleteFromHistory(index){
      if(!confirm("¬øEliminar esta cotizaci√≥n del historial?")) return;
      history.splice(index, 1);
      localStorage.setItem(STORAGE.history, JSON.stringify(history));
      renderHistory();
    }

    function clearHistory(){
      if(!confirm("¬øBorrar TODO el historial?")) return;
      history = [];
      localStorage.removeItem(STORAGE.history);
      renderHistory();
    }

    function quoteToMessage(q){
      const dt = nowDateTimeVE();

      const itemsLines = q.items.map((it, i)=>{
        const qty = it.qty ? ` ‚Ä¢ Cant: ${it.qty}` : "";
        return `${i+1}) ${it.name}${qty}\n   - Precio: $${fmt(it.subtotal)} | Imp: $${fmt(it.tax)} | Total: $${fmt(it.total)}`;
      }).join("\n");

      const totalArticulosUSD = q.totalItemsUSD;
      const envioUSD = q.shippingUSD;
      const totalUSD = q.totalUSD;

      const inicialUSD = q.initialUSD;
      const restanteUSD = q.remainingUSD;

      const initialPct = Number(q.initialPct ?? (totalUSD > 0 ? (inicialUSD / totalUSD) * 100 : DEFAULT_INITIAL_PCT));

      const tasa = Number(q.bcv || 0);
      const inicialBs = tasa ? q.initialBs : 0;
      const totalBs = tasa ? q.totalBs : 0;

      const payBS = (payments.bs || "").trim();
      const payUSD = (payments.usd || "").trim();
      const payCOP = (payments.cop || "").trim();
      const payUSDT = (payments.usdt || "").trim();

      const termsBlock = formatTermsForWA(termsText || DEFAULT_TERMS_LINES);

      const msg = [
`üßæ *COTIZACI√ìN*
üè∑Ô∏è Tienda: *${q.brand || "‚Äî"}*
üë§ Cliente: *${q.client || "‚Äî"}*
üìÖ Fecha: ${q.date || "‚Äî"}`,

`üì¶ *DETALLE DE ART√çCULOS*
${itemsLines}`,

`üí∞ *RESUMEN (USD)*
‚Ä¢ Total costo art√≠culos: *$${fmt(totalArticulosUSD)}*
‚Ä¢ Env√≠o internacional (${fmtPct(q.shippingPct)}%): *$${fmt(envioUSD)}*
‚Ä¢ *TOTAL A PAGAR: $${fmt(totalUSD)}*`,

`‚úÖ *PAGO INICIAL*
‚Ä¢ Inicial: *${fmtPct(initialPct)}%*  ‚Üí  *$${fmt(inicialUSD)}*
‚Ä¢ Inicial en Bs: *${tasa ? fmt(inicialBs) + " Bs" : "‚Äî"}*`,

`üßÆ *RESTANTE*
‚Ä¢ Restante: *$${fmt(restanteUSD)}*`,

`üìà *TASA BCV*
‚Ä¢ Tasa usada: *${tasa ? fmt(tasa) + " Bs/USD" : "No indicada"}*
‚Ä¢ Total en Bs (referencia): *${tasa ? fmt(totalBs) + " Bs" : "‚Äî"}*`,

`üìù *NOTA*
El monto en Bs es una *referencia calculada* seg√∫n la tasa BCV usada al momento de esta cotizaci√≥n.
‚è±Ô∏è Generado: ${dt}`,

`üìå *T√âRMINOS Y CONDICIONES*
${termsBlock}`,

`üí≥ *M√âTODOS DE PAGO*
‚Ä¢ *Bol√≠vares (Bs):* ${payBS || "‚Äî"}
‚Ä¢ *D√≥lares (USD):* ${payUSD || "‚Äî"}
‚Ä¢ *Pesos Colombianos (COP):* ${payCOP || "‚Äî"}
‚Ä¢ *USDT:* ${payUSDT || "‚Äî"}`
      ].join("\n\n");

      return msg;
    }

    function shareWhatsApp(q){
      if(!q){ alert("Primero calcula una cotizaci√≥n."); return; }
      const msg = encodeURIComponent(quoteToMessage(q));
      window.open(`https://wa.me/?text=${msg}`, "_blank");
    }

    function exportPDF(q){
      if(!q){ alert("Primero calcula una cotizaci√≥n."); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("Cotizaci√≥n", 14, 16);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      let y = 26;

      const head = [
        q.client ? `Cliente: ${q.client}` : "",
        q.brand ? `Tienda: ${q.brand}` : "",
        q.date ? `Fecha: ${q.date}` : "",
        q.bcv ? `Tasa: ${fmt(q.bcv)} Bs/USD` : ""
      ].filter(Boolean);

      head.forEach(line=>{ doc.text(line, 14, y); y += 6; });

      y += 4;
      doc.setFont("helvetica", "bold");
      doc.text("Items:", 14, y); y += 7;

      doc.setFont("helvetica", "normal");
      q.items.forEach(it=>{
        const qty = it.qty ? ` (Cant: ${it.qty})` : "";
        const line = `- ${it.name}${qty}: $${fmt(it.total)} (P $${fmt(it.subtotal)} + I $${fmt(it.tax)})`;
        doc.text(line, 14, y);
        y += 6;
        if(y > 270){ doc.addPage(); y = 20; }
      });

      y += 6;
      doc.setFont("helvetica", "bold");
      doc.text(`Total USD: $${fmt(q.totalUSD)}`, 14, y); y += 6;

      const pct = Number(q.initialPct ?? (q.totalUSD > 0 ? (q.initialUSD / q.totalUSD) * 100 : DEFAULT_INITIAL_PCT));
      doc.setFont("helvetica", "normal");
      doc.text(`Inicial (${fmtPct(pct)}%): $${fmt(q.initialUSD)}  |  Restante USD: $${fmt(q.remainingUSD)}`, 14, y); y += 6;

      if(q.bcv){
        doc.text(`Total Bs (referencia): ${fmt(q.totalBs)} Bs`, 14, y); y += 6;
      }

      doc.save(`Cotizacion_${(q.client||"Cliente").replace(/\s+/g,"_")}.pdf`);
    }

    async function updateRate({force=false}={}){
      const bcv = $("bcv");
      const state = $("rateState");

      const last = Number(localStorage.getItem(STORAGE.rate) || 0);
      const lastDay = localStorage.getItem(STORAGE.rate_last_day) || "";
      const today = nowISODate();

      if(!force && last && lastDay === today){
        bcv.value = last;
        state.textContent = "Tasa guardada";
        updateInitialPreview();
        return;
      }

      try{
        state.textContent = "Actualizando...";
        const res = await fetch("https://open.er-api.com/v6/latest/USD");
        const data = await res.json();
        const rate = data?.rates?.VES;
        if(!rate) throw new Error("Sin tasa");
        const r = Number(rate).toFixed(2);
        bcv.value = r;
        localStorage.setItem(STORAGE.rate, r);
        localStorage.setItem(STORAGE.rate_last_day, today);
        state.textContent = "Tasa actualizada";
        updateInitialPreview();
      }catch(e){
        state.textContent = "Tasa manual";
        updateInitialPreview();
      }
    }

    function resetAll(){
      if(!confirm("¬øReiniciar formulario e √≠tems? (No borra historial)")) return;
      items = [];
      lastQuote = null;
      localStorage.removeItem(STORAGE.last_quote);

      $("client").value = "";
      $("date").value = nowISODate();
      $("brand").value = "";
      $("itemType").value = "Ropa";
      $("shipping").value = "";
      $("initial").value = String(DEFAULT_INITIAL_PCT);
      $("bcv").value = "";

      $("itemQty").value = "";
      $("itemPrice").value = "";
      $("itemTax").value = "";

      $("results").innerHTML = `<div class="muted">Sin cotizaci√≥n todav√≠a.</div>`;
      renderItemsChips();
      saveDraft();
      updateAddBtn();
      updateInitialPreview();
    }

    function setClientMode(enabled){
      document.body.classList.toggle("client", !!enabled);
      const btn = $("clientModeBtn");
      if(btn) btn.textContent = enabled ? "Salir de Modo Cliente" : "Modo Cliente";
      $("modeBadge").textContent = enabled ? "Cliente" : "Admin";

      if(enabled){
        $("calcDetails").open = true;
        $("results").scrollIntoView({behavior:"smooth", block:"start"});
      }
      localStorage.setItem(STORAGE.mode, enabled ? "client" : "admin");
    }

    // Events
    $("privateToggleBtn").onclick = togglePrivateSection;

    $("addItemBtn").onclick = addItem;
    $("calcBtn").onclick = calculate;
    $("pdfBtn").onclick = () => exportPDF(lastQuote);
    $("waBtn").onclick = () => shareWhatsApp(lastQuote);
    $("resetBtn").onclick = resetAll;
    $("clearHistoryBtn").onclick = clearHistory;

    $("clientModeBtn").onclick = ()=>{
      const enabled = !document.body.classList.contains("client");
      if(enabled && !lastQuote && history.length > 0) lastQuote = history[0];
      if(lastQuote) localStorage.setItem(STORAGE.last_quote, JSON.stringify(lastQuote));
      setClientMode(enabled);
      if(enabled && lastQuote) renderResults(lastQuote);
    };

    // Autosave & preview updates
    ["client","date"].forEach(id=> $(id).addEventListener("input", saveDraft));
    ["shipping","initial","bcv"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        saveDraft();
        updateInitialPreview();
      });
    });

    ["brand","itemType"].forEach(id=>{
      $(id).addEventListener("change", ()=>{
        saveDraft();
        updateAddBtn();
        updateInitialPreview();
      });
    });

    ["pay_bs","pay_usd","pay_cop","pay_usdt"].forEach(id=> $(id).addEventListener("input", readPaymentsFromUI));
    $("terms_text").addEventListener("input", readTermsFromUI);

    // Mini calc 1
    function m1(op){
      const a = Number($("m1a").value||0);
      const b = Number($("m1b").value||0);
      let r = 0;
      if(op === "+") r = a + b;
      if(op === "-") r = a - b;
      if(op === "*") r = a * b;
      $("m1out").textContent = fmt(r);
    }
    $("m1plus").onclick = ()=>m1("+");
    $("m1minus").onclick = ()=>m1("-");
    $("m1mul").onclick = ()=>m1("*");

    // Mini calc 2
    function m2(op){
      const a = Number($("m2a").value || 0);
      const b = Number($("m2b").value || 0);
      const rate = Number($("bcv").value || 0);

      if(!rate || rate <= 0){
        $("m2out").textContent = "Coloca la Tasa BCV para convertir.";
        return;
      }

      let bs = 0;
      if(op === "+") bs = a + b;
      if(op === "-") bs = a - b;
      if(op === "*") bs = a * b;

      const usd = bs / rate;
      $("m2out").textContent = "$" + fmt(usd);
    }
    $("m2plus").onclick = ()=>m2("+");
    $("m2minus").onclick = ()=>m2("-");
    $("m2mul").onclick = ()=>m2("*");

    $("rateBtn").onclick = ()=>updateRate({force:true});

    // Start
    loadDraft();
    applyPaymentsToUI();
    applyTermsToUI();
    ensureDefaultInitialPct();
    renderHistory();
    renderItemsChips();
    updateAddBtn();
    updateInitialPreview();

    const savedMode = localStorage.getItem(STORAGE.mode);
    if(savedMode === "client"){
      if(!lastQuote && history.length > 0) lastQuote = history[0];
      if(lastQuote) localStorage.setItem(STORAGE.last_quote, JSON.stringify(lastQuote));
      setClientMode(true);
      if(lastQuote) renderResults(lastQuote);
    }else{
      $("modeBadge").textContent = "Admin";
      document.body.classList.remove("client");
    }

    updateRate({ force: false });
    updatePrivateToggleText();

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(()=>{});
    }
  }

  /* ===========================
     LOGIN EVENTS
     =========================== */
  $("loginBtn").addEventListener("click", doLogin);
  $("loginClearBtn").addEventListener("click", ()=>{
    $("loginPass").value = "";
    $("loginPass").focus();
  });
  $("loginPass").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") doLogin();
  });
  $("logoutBtn").addEventListener("click", doLogout);

  // Arranque: si no hay usuario activo -> login
  updateActiveUserBadge();
  boot();

})();
</script>
</body>
</html>
