<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Cotizador Pro</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- ‚úÖ PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007AFF">

<style>
  :root{
    --primary:#007AFF;
    --danger:#ff3b30;
    --bg:#f2f2f7;
    --card:#ffffff;
    --text:#1c1c1e;
    --muted:#6b7280;
    --field:#e5e5ea;
    --shadow: 0 18px 40px rgba(0,0,0,.12);
    --radius: 18px;

    /* Premium motion tokens */
    --ease-out: cubic-bezier(.2,.8,.2,1);
    --ease-inout: cubic-bezier(.4,0,.2,1);
    --t-fast: 140ms;
    --t-med: 260ms;
    --t-slow: 420ms;

    --ring: 0 0 0 4px rgba(0,122,255,.16);
  }

  body{
    margin:0;
    font-family:'Roboto',sans-serif;
    background:var(--bg);
    color:var(--text);
    transition: background .35s ease, color .35s ease;
    -webkit-tap-highlight-color: transparent;
  }

  body.dark{
    --bg:#000;
    --card:#1c1c1e;
    --text:#f2f2f7;
    --muted:#9ca3af;
    --field:#2c2c2e;
    --shadow: 0 18px 40px rgba(0,0,0,.55);
  }

  /* Premium global transitions */
  *{
    transition:
      background-color var(--t-med) var(--ease-out),
      color var(--t-med) var(--ease-out),
      border-color var(--t-med) var(--ease-out),
      box-shadow var(--t-med) var(--ease-out),
      transform var(--t-fast) var(--ease-out),
      opacity var(--t-med) var(--ease-out),
      filter var(--t-fast) var(--ease-out);
  }

  .container{
    max-width:560px;
    margin: 0 auto;
    padding: 14px;
    padding-bottom: 110px;
  }

  .topbar{
    position: sticky;
    top: 0;
    z-index: 50;
    padding: 10px 0 12px;
    backdrop-filter: blur(12px);
    background: color-mix(in srgb, var(--bg) 82%, transparent);
    border-bottom: 1px solid color-mix(in srgb, var(--field) 55%, transparent);
  }

  .brand{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    font-weight:800;
    letter-spacing:.2px;
    font-size:17px;
  }

  .brand .badge{
    width:34px;
    height:34px;
    border-radius:12px;
    display:grid;
    place-items:center;
    background: color-mix(in srgb, var(--primary) 14%, var(--card));
    color: var(--primary);
    box-shadow: 0 10px 25px rgba(0,122,255,.18);
    transform: translateZ(0);
  }

  .card{
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: 0 12px 30px rgba(0,0,0,.10);
    padding: 16px;
    animation: floatIn .42s var(--ease-out) both;
  }
  body.dark .card{
    box-shadow: 0 14px 34px rgba(0,0,0,.45);
  }

  /* Softer premium entrance */
  @keyframes floatIn{
    from{ opacity:0; transform: translateY(14px) scale(.995); filter: blur(2px); }
    to{ opacity:1; transform: translateY(0) scale(1); filter: blur(0); }
  }

  h2{
    margin: 10px 0 6px;
    text-align:center;
    font-size:18px;
  }

  .sub{
    text-align:center;
    color: var(--muted);
    font-size: 13px;
    margin-bottom: 14px;
  }

  .grid{ display:grid; gap:12px; }

  label{
    display:block;
    font-size:13px;
    color: var(--muted);
    margin-bottom: 6px;
  }

  input{
    width:100%;
    box-sizing:border-box;
    border:none;
    background: var(--field);
    color: var(--text);
    padding: 14px 14px;
    border-radius: 16px;
    font-size: 16px;
    border: 1px solid transparent;
  }

  input:focus{
    outline:none;
    transform: translateY(-1px);
    box-shadow: var(--ring);
    border-color: color-mix(in srgb, var(--primary) 35%, transparent);
  }

  .row2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }

  .btn{
    width:100%;
    border:none;
    padding: 14px 14px;
    border-radius: 16px;
    font-size: 15px;
    font-weight: 700;
    cursor:pointer;
    background: var(--primary);
    color: #fff;
    transform: translateZ(0);
    will-change: transform, filter;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:active{ transform: translateY(0) scale(.98); filter: brightness(.95); }

  .btn.secondary{
    background: color-mix(in srgb, var(--primary) 14%, var(--card));
    color: var(--primary);
  }

  .btn.danger{
    background: color-mix(in srgb, var(--danger) 14%, var(--card));
    color: var(--danger);
  }

  .btn.ghost{
    background: transparent;
    color: var(--primary);
    border: 1px solid color-mix(in srgb, var(--primary) 26%, var(--field));
  }

  .mini-actions{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .toggle-theme{
    position: fixed;
    top: 12px;
    right: 12px;
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background: color-mix(in srgb, var(--card) 40%, #3a3a3c);
    color: #fff;
    font-size: 18px;
    z-index: 60;
    box-shadow: 0 12px 25px rgba(0,0,0,.25);
    border: 1px solid color-mix(in srgb, var(--field) 65%, transparent);
  }
  .toggle-theme:active{ transform: scale(.95); }

  .results{
    margin-top: 14px;
    background: color-mix(in srgb, var(--field) 70%, var(--card));
    border-radius: 18px;
    padding: 14px;
    font-size: 14px;
    line-height: 1.35;
    animation: floatIn .32s var(--ease-out) both;
    border: 1px solid color-mix(in srgb, var(--field) 70%, transparent);
  }

  .muted{ color: var(--muted); }

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top: 8px;
  }
  .chip{
    font-size:12px;
    padding: 8px 10px;
    border-radius: 999px;
    background: color-mix(in srgb, var(--primary) 12%, var(--card));
    color: var(--primary);
    border: 1px solid color-mix(in srgb, var(--primary) 30%, var(--field));
    transform: translateZ(0);
  }
  .chip:hover{ transform: translateY(-1px); }

  .section{ margin-top: 14px; }

  details{
    border-radius: 18px;
    background: color-mix(in srgb, var(--field) 55%, var(--card));
    padding: 12px;
    border: 1px solid color-mix(in srgb, var(--field) 70%, transparent);
  }

  summary{
    list-style:none;
    cursor:pointer;
    font-weight:800;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  summary::-webkit-details-marker{ display:none; }

  .history{
    margin-top: 10px;
    display:grid;
    gap:8px;
  }

  .history-item{
    background: var(--card);
    border-radius: 16px;
    padding: 12px;
    border: 1px solid color-mix(in srgb, var(--field) 65%, transparent);
    box-shadow: none;
    animation: floatIn .25s var(--ease-out) both;
  }

  .history-item .top{
    display:flex;
    justify-content:space-between;
    gap:10px;
    font-weight: 800;
  }
  .history-item .meta{
    margin-top: 6px;
    font-size: 12px;
    color: var(--muted);
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }

  .calc-grid{
    display:grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-top: 10px;
  }

  .calc-card{
    background: var(--card);
    border-radius: 18px;
    padding: 12px;
    border: 1px solid color-mix(in srgb, var(--field) 65%, transparent);
  }

  .calc-card h4{
    margin: 0 0 10px;
    font-size: 14px;
  }

  .op-row{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
  }

  .op-btn{
    border:none;
    border-radius: 14px;
    padding: 12px 10px;
    font-weight: 900;
    cursor:pointer;
    background: color-mix(in srgb, var(--primary) 16%, var(--card));
    color: var(--primary);
    transform: translateZ(0);
    will-change: transform, filter;
  }
  .op-btn:hover{ transform: translateY(-1px); }
  .op-btn:active{ transform: translateY(0) scale(.98); }

  @media (max-width: 768px){
    body{ font-size:15px; }
    .container{ padding:12px; padding-bottom:130px; }
    .card{ padding:14px; border-radius:20px; }
    h2{ font-size:17px; }
    .row2{ grid-template-columns: 1fr; }
    input{ font-size:16px; padding:16px; border-radius:18px; }
    .btn{ padding:16px; font-size:16px; border-radius:18px; }
    .mini-actions{ grid-template-columns: 1fr; }
    .chips{ gap:6px; }
    .chip{ font-size:11px; padding:6px 10px; }
    .results{ font-size:14px; padding:16px; border-radius:20px; }
    .history-item{ border-radius:18px; }
    .footerbar{ padding:12px; }
    .footerbar .wrap{ grid-template-columns: 1fr; gap:10px; }
    .calc-card{ padding:14px; }
    .op-row{ grid-template-columns: 1fr 1fr 1fr; }
    .op-btn{ padding:14px 10px; font-size:16px; }
    .toggle-theme{ width:42px; height:42px; font-size:20px; }
  }

  .small{
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
  }

  .footerbar{
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
    background: color-mix(in srgb, var(--bg) 86%, transparent);
    backdrop-filter: blur(12px);
    z-index: 40;
  }
  .footerbar .wrap{
    max-width:560px;
    margin: 0 auto;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr; /* 3 botones */
    gap: 10px;
  }

  /* =========================
     VISTA CLIENTE (modo limpio)
     ========================= */
  body.client #privateDetails,
  body.client #historyDetails{
    display:none !important;
  }
  body.client #itemsDetails{
    display:none !important;
  }
  body.client .sub{ opacity:.65; }
  body.client .footerbar .wrap{ grid-template-columns: 1fr; }

  /* Entrance helper */
  .fade-enter{ opacity:0; transform: translateY(6px); }
  .fade-enter.fade-enter-active{ opacity:1; transform: translateY(0); }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce){
    *{ transition:none !important; animation:none !important; }
  }
</style>
</head>

<body>
<button class="toggle-theme" id="themeToggle" aria-label="Cambiar tema">üåô</button>

<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="badge">‚òÖ</div>
      <div id="brandTitle">IMPORTACIONES DESDE CHINA</div>
    </div>
  </div>

  <div class="card">
    <h2>Cotizador Profesional</h2>
    <div class="sub">PWA ‚Ä¢ iOS-like ‚Ä¢ Historial ‚Ä¢ PDF ‚Ä¢ WhatsApp ‚Ä¢ Ajustes Privados</div>

    <div class="grid">
      <div>
        <label>Cliente</label>
        <input id="client" type="text" placeholder="Ej: Nombre y apellido">
      </div>

      <div class="row2">
        <div>
          <label>Fecha</label>
          <input id="date" type="date">
        </div>
        <div>
          <label>Tienda</label>
          <input id="brand" type="text" placeholder="Ej: Shein / Temu">
        </div>
      </div>

      <div class="section">
        <details open id="itemsDetails">
          <summary>
            <span>Agregar √≠tem</span>
            <span class="muted" id="itemsCount">0</span>
          </summary>

          <div class="grid" style="margin-top:12px;">
            <div>
              <label>Articulos / Servicio</label>
              <input id="itemName" type="text" placeholder="Ej: Ropa, accesorios, otros">
            </div>

            <div class="row2">
              <div>
                <label>Cantidad de articulos (informativa)</label>
                <input id="itemQty" type="number" inputmode="numeric" placeholder="Ej: 2">
              </div>
              <div>
                <label>Total articulos (USD)</label>
                <input id="itemPrice" type="number" inputmode="decimal" placeholder="Ej: 15">
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Impuesto % (opcional)</label>
                <input id="itemTax" type="number" inputmode="decimal" placeholder="Ej: 16">
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btn secondary" id="addItemBtn" type="button">Agregar √≠tem</button>
              </div>
            </div>

            <div class="chips" id="itemsChips"></div>
            <div class="small">Tip: toca un chip para eliminar ese √≠tem.</div>
          </div>
        </details>
      </div>

      <div class="section">
        <details open id="calcDetails">
          <summary>
            <span>C√°lculo</span>
            <span class="muted">USD / Bs</span>
          </summary>

          <div class="grid" style="margin-top:12px;">
            <div class="row2">
              <div>
                <label>Env√≠o %</label>
                <input id="shipping" type="number" inputmode="decimal" placeholder="Ej: 10">
              </div>
              <div>
                <label>Inicial %</label>
                <input id="initial" type="number" inputmode="decimal" placeholder="Ej: 30">
              </div>
            </div>

            <!-- ‚úÖ BCV AUTO + MANUAL -->
            <div>
              <label>Tasa BCV (Bs/USD)</label>
              <input id="bcv" type="number" inputmode="decimal" placeholder="Ej: 36.50">

              <div class="mini-actions" style="margin-top:10px;">
                <button class="btn secondary" id="updateRateBtn" type="button">Actualizar tasa</button>
                <button class="btn ghost" id="useManualBtn" type="button">Usar manual</button>
              </div>

              <div class="small" id="rateStatus">Tasa: manual (sin actualizar).</div>
              <div class="small">Esta tasa tambi√©n se usa en Bs ‚Üí USD.</div>
            </div>

            <div class="mini-actions">
              <button class="btn" id="calcBtn" type="button">Calcular</button>
              <button class="btn ghost" id="pdfBtn" type="button">Exportar PDF</button>
            </div>

            <div class="mini-actions">
              <button class="btn secondary" id="waBtn" type="button">Compartir WhatsApp</button>
              <button class="btn danger" id="resetBtn" type="button">Reiniciar</button>
            </div>

            <div class="results" id="results">
              <div class="muted">Sin cotizaci√≥n todav√≠a.</div>
            </div>
          </div>
        </details>
      </div>

      <div class="section">
        <details id="privateDetails">
          <summary>
            <span>Ajustes Privados</span>
            <span class="muted">Mini calculadoras</span>
          </summary>

          <div class="calc-grid">
            <div class="calc-card">
              <h4>Mini Calculadora </h4>
              <div class="row2">
                <input id="usd1" type="number" inputmode="decimal" placeholder="Cifra">
                <input id="usd2" type="number" inputmode="decimal" placeholder="Cifra">
              </div>
              <div class="op-row">
                <button class="op-btn" type="button" data-usd-op="+">‚ûï</button>
                <button class="op-btn" type="button" data-usd-op="-">‚ûñ</button>
                <button class="op-btn" type="button" data-usd-op="*">‚úñÔ∏è</button>
              </div>
              <div class="mini-actions" style="margin-top:10px;">
                <button class="btn secondary" id="usdClearBtn" type="button">Limpiar</button>
                <button class="btn ghost" id="usdCopyBtn" type="button">Copiar</button>
              </div>
              <div class="results" id="usdRes"><div class="muted">Resultado: -</div></div>
            </div>

            <div class="calc-card">
              <h4>Mini Calculadora Bs ‚Üí USD</h4>
              <div class="row2">
                <input id="bs1" type="number" inputmode="decimal" placeholder="Monto Bs">
                <input id="bs2" type="number" inputmode="decimal" placeholder="Monto Bs">
              </div>
              <div class="op-row">
                <button class="op-btn" type="button" data-bs-op="+">‚ûï</button>
                <button class="op-btn" type="button" data-bs-op="-">‚ûñ</button>
                <button class="op-btn" type="button" data-bs-op="*">‚úñÔ∏è</button>
              </div>
              <div class="mini-actions" style="margin-top:10px;">
                <button class="btn secondary" id="bsClearBtn" type="button">Limpiar</button>
                <button class="btn ghost" id="bsCopyBtn" type="button">Copiar</button>
              </div>
              <div class="results" id="bsRes"><div class="muted">Resultado: -</div></div>
              <div class="small">Convierte usando la tasa BCV arriba.</div>
            </div>
          </div>
        </details>
      </div>

      <div class="section">
        <details open id="historyDetails">
          <summary>
            <span>Historial</span>
            <span class="muted" id="historyCount">0</span>
          </summary>

          <div class="mini-actions" style="margin-top:12px;">
            <button class="btn secondary" id="exportHistoryBtn" type="button">Exportar historial (PDF)</button>
            <button class="btn danger" id="clearHistoryBtn" type="button">Borrar historial</button>
          </div>

          <div class="history" id="historyList"></div>
        </details>
      </div>
    </div>
  </div>
</div>

<div class="footerbar">
  <div class="wrap">
    <button class="btn secondary" type="button" onclick="document.getElementById('privateDetails').open = true; document.getElementById('privateDetails').scrollIntoView({behavior:'smooth'});">
      Ajustes Privados
    </button>
    <button class="btn" type="button" onclick="document.getElementById('historyList').scrollIntoView({behavior:'smooth'});">
      Ver Historial
    </button>
    <button class="btn ghost" id="clientModeBtn" type="button">Modo Cliente</button>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const CONFIG = {
    brandName: "IMPORTACIONES DESDE CHINA",
    whatsappBase: "https://wa.me/?text="
  };

  // =========================
  // HELPERS
  // =========================
  const $ = (id) => document.getElementById(id);
  const money = (n) => (Number(n || 0)).toFixed(2);
  const nowISODate = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  };

  const STORAGE = {
    draft: "cotizador_draft_v1",
    history: "cotizador_history_v1",
    theme: "cotizador_theme_v1",
    mode: "cotizador_mode_v1",

    // ‚úÖ RATE META
    rate: "cotizador_rate_v1",
    rate_last_day: "cotizador_rate_day_v1"
  };

  let items = [];
  let lastQuote = null;
  let history = JSON.parse(localStorage.getItem(STORAGE.history) || "[]");

  // =========================
  // INIT
  // =========================
  $("brandTitle").textContent = CONFIG.brandName;
  if(!$("date").value) $("date").value = nowISODate();

  const savedTheme = localStorage.getItem(STORAGE.theme);
  if(savedTheme === "dark"){
    document.body.classList.add("dark");
    $("themeToggle").textContent = "‚òÄÔ∏è";
  }

  // =========================
  // RATE AUTO (emprendimiento)
  // =========================
  function setRateStatus(text){
    const el = $("rateStatus");
    if(el) el.textContent = text;
  }

  function todayKey(){
    return new Date().toDateString();
  }

  function saveRateMeta(rate, source){
    const meta = {
      rate: Number(rate),
      source: source || "unknown",
      updatedAt: new Date().toISOString()
    };
    localStorage.setItem(STORAGE.rate, JSON.stringify(meta));
    localStorage.setItem(STORAGE.rate_last_day, todayKey());
  }

  function loadRateMeta(){
    const raw = localStorage.getItem(STORAGE.rate);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }

  async function fetchUSDVES(){
    // Proveedor p√∫blico sin key (puede cambiar con el tiempo)
    const r = await fetch("https://open.er-api.com/v6/latest/USD", { cache: "no-store" });
    const d = await r.json();
    if(d?.result === "success" && d?.rates?.VES){
      return { rate: Number(d.rates.VES), source: "open.er-api.com" };
    }
    throw new Error("Proveedor no devolvi√≥ VES");
  }

  async function updateRate({ force = false } = {}){
    try{
      const lastDay = localStorage.getItem(STORAGE.rate_last_day);

      // Si no es forzado, solo 1 vez al d√≠a
      if(!force && lastDay === todayKey()){
        const meta = loadRateMeta();
        if(meta?.rate){
          $("bcv").value = Number(meta.rate).toFixed(2);
          setRateStatus(`Tasa autom√°tica (cache): ${Number(meta.rate).toFixed(2)} ‚Ä¢ ${new Date(meta.updatedAt).toLocaleString()}`);
          saveDraft();
        }
        return;
      }

      setRateStatus("Actualizando tasa...");

      const { rate, source } = await fetchUSDVES();
      if(!Number.isFinite(rate) || rate <= 0) throw new Error("Tasa inv√°lida");

      $("bcv").value = rate.toFixed(2);
      saveRateMeta(rate, source);
      setRateStatus(`Tasa autom√°tica: ${rate.toFixed(2)} ‚Ä¢ Fuente: ${source} ‚Ä¢ ${new Date().toLocaleString()}`);
      saveDraft();
    }catch(err){
      console.warn("Error actualizando tasa:", err);
      const meta = loadRateMeta();
      if(meta?.rate){
        $("bcv").value = Number(meta.rate).toFixed(2);
        setRateStatus(`No se pudo actualizar. Usando √∫ltima guardada: ${Number(meta.rate).toFixed(2)} ‚Ä¢ ${new Date(meta.updatedAt).toLocaleString()}`);
        saveDraft();
        return;
      }
      setRateStatus("No se pudo actualizar. Coloca la tasa manualmente.");
    }
  }

  // =========================
  // DRAFT SAVE/LOAD
  // =========================
  function saveDraft(){
    const draft = {
      client: $("client").value,
      date: $("date").value,
      brand: $("brand").value,
      shipping: $("shipping").value,
      initial: $("initial").value,
      bcv: $("bcv").value,
      items
    };
    localStorage.setItem(STORAGE.draft, JSON.stringify(draft));
  }

  function loadDraft(){
    const raw = localStorage.getItem(STORAGE.draft);
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      $("client").value = d.client || "";
      $("date").value = d.date || nowISODate();
      $("brand").value = d.brand || "";
      $("shipping").value = d.shipping || "";
      $("initial").value = d.initial || "";
      $("bcv").value = d.bcv || "";
      items = Array.isArray(d.items) ? d.items : [];
      renderItemsChips();
    }catch(e){}
  }

  ["client","date","brand","shipping","initial","bcv"].forEach(id=>{
    $(id).addEventListener("input", saveDraft);
    $(id).addEventListener("change", saveDraft);
  });

  // =========================
  // ITEMS
  // =========================
  function renderItemsChips(){
    $("itemsCount").textContent = items.length;
    const wrap = $("itemsChips");
    wrap.innerHTML = "";

    items.forEach((it, idx) => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = `${it.qty || "-"}x ${it.name} ‚Üí $${money(it.total)}`;
      chip.title = "Toca para eliminar";
      chip.style.cursor = "pointer";
      chip.addEventListener("click", () => {
        items.splice(idx,1);
        renderItemsChips();
        saveDraft();
      });
      wrap.appendChild(chip);
    });
  }

  function addItem(){
    const name = $("itemName").value.trim();
    const qty = $("itemQty").value.trim();
    const price = parseFloat($("itemPrice").value);
    const taxPct = parseFloat($("itemTax").value) || 0;

    if(!name || Number.isNaN(price)){
      alert("Completa el √≠tem (nombre y precio).");
      return;
    }

    const taxAmount = price * (taxPct / 100);
    const total = price + taxAmount; // cantidad informativa

    items.push({ name, qty, price, taxPct, taxAmount, total });

    $("itemName").value = "";
    $("itemQty").value = "";
    $("itemPrice").value = "";
    $("itemTax").value = "";

    renderItemsChips();
    saveDraft();
  }

  // =========================
  // RESULTS (con Vista Cliente)
  // =========================
  function renderResults(q){
    const isClient = document.body.classList.contains("client");

    const itemsHTML = (q.items || [])
      .map(it => `<div class="muted" style="display:flex;justify-content:space-between;gap:10px;">
        <span>${it.qty || "-"}x ${it.name}</span>
        <span>$${money(it.total)}</span>
      </div>`)
      .join("");

    const bcvHTML = isClient ? "" : `
      <div style="margin-top:10px;" class="muted">
        <div><strong>BCV:</strong> Bs ${money(q.bcv)}</div>
        <div><strong>Fuente:</strong> ${q.bcvSource || "manual"}${q.bcvUpdatedAt ? ` ‚Ä¢ ${new Date(q.bcvUpdatedAt).toLocaleString()}` : ""}</div>
        <div style="margin-top:6px;"><strong>Total Bs:</strong> Bs ${money(q.totalBs)}</div>
        <div><strong>Inicial Bs:</strong> Bs ${money(q.initialBs)}</div>
        <div><strong>Restante Bs:</strong> Bs ${money(q.remainingBs)}</div>
      </div>
    `;

    $("results").innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;font-weight:900;font-size:16px;">
        <div>Total</div>
        <div>$${money(q.totalUSD)}</div>
      </div>

      <div class="muted" style="margin-top:10px;">
        <div><strong>Cliente:</strong> ${q.client}</div>
        <div><strong>Fecha:</strong> ${q.date}</div>
        <div><strong>Marca:</strong> ${q.brand}</div>
      </div>

      <div style="margin-top:12px;">
        <div style="font-weight:800;margin-bottom:6px;">Items</div>
        ${itemsHTML || `<div class="muted">-</div>`}
      </div>

      <div style="margin-top:12px;">
        <div><strong>Art√≠culos:</strong> $${money(q.totalItemsUSD)}</div>
        <div><strong>Env√≠o (${money(q.shippingPct)}%):</strong> $${money(q.shippingUSD)}</div>
        <div style="margin-top:6px;"><strong>Inicial (${money(q.initialPct)}%):</strong> $${money(q.initialUSD)}</div>
        <div><strong>Restante:</strong> $${money(q.remainingUSD)}</div>
      </div>

      ${bcvHTML}
    `;
  }

  function calculate(){
    const client = $("client").value.trim();
    const date = $("date").value || nowISODate();
    const brand = $("brand").value.trim();
    const shippingPct = parseFloat($("shipping").value) || 0;
    const initialPct = parseFloat($("initial").value) || 0;
    const bcv = parseFloat($("bcv").value) || 1;

    // ‚úÖ congelar metadata de tasa usada en esta cotizaci√≥n
    const rateMeta = loadRateMeta();
    const bcvSource = rateMeta?.source || "manual";
    const bcvUpdatedAt = rateMeta?.updatedAt || null;

    if(!client || !brand){ alert("Completa Cliente y Marca."); return; }
    if(items.length === 0){ alert("Agrega al menos 1 √≠tem."); return; }

    const totalItemsUSD = items.reduce((s,it)=> s + (it.total || 0), 0);
    const shippingUSD = totalItemsUSD * (shippingPct / 100);
    const totalUSD = totalItemsUSD + shippingUSD;

    const initialUSD = totalUSD * (initialPct / 100);
    const remainingUSD = totalUSD - initialUSD;

    const totalBs = totalUSD * bcv;
    const initialBs = initialUSD * bcv;
    const remainingBs = remainingUSD * bcv;

    const quote = {
      id: crypto?.randomUUID?.() || String(Date.now()),
      createdAt: new Date().toISOString(),
      client, date, brand,
      items: [...items],
      shippingPct, initialPct, bcv,

      // ‚úÖ NUEVO: tasa congelada
      bcvSource,
      bcvUpdatedAt,

      totalItemsUSD, shippingUSD, totalUSD,
      initialUSD, remainingUSD,
      totalBs, initialBs, remainingBs
    };

    lastQuote = quote;
    renderResults(quote);

    history.unshift(quote);
    history = history.slice(0, 50);
    localStorage.setItem(STORAGE.history, JSON.stringify(history));
    renderHistory();
    saveDraft();
  }

  // =========================
  // HISTORY
  // =========================
  function renderHistory(){
    $("historyCount").textContent = history.length;
    const list = $("historyList");
    list.innerHTML = "";

    if(history.length === 0){
      list.innerHTML = `<div class="muted">No hay historial a√∫n.</div>`;
      return;
    }

    history.forEach((q, idx) => {
      const el = document.createElement("div");
      el.className = "history-item";
      el.innerHTML = `
        <div class="top">
          <div>${q.client}</div>
          <div>$${money(q.totalUSD)}</div>
        </div>
        <div class="meta">
          <span>üìÖ ${q.date}</span>
          <span>üè∑Ô∏è ${q.brand}</span>
          <span>üßæ ${q.items?.length || 0} √≠tems</span>
        </div>
        <div class="mini-actions" style="margin-top:10px;">
          <button class="btn secondary" type="button" data-load="${idx}">Cargar</button>
          <button class="btn ghost" type="button" data-wa="${idx}">WhatsApp</button>
        </div>
        <button class="btn danger" style="margin-top:10px;" type="button" data-del="${idx}">Eliminar</button>
      `;
      list.appendChild(el);
    });
  }

  function loadFromHistory(index){
    const q = history[index];
    if(!q) return;

    $("client").value = q.client || "";
    $("date").value = q.date || nowISODate();
    $("brand").value = q.brand || "";
    $("shipping").value = q.shippingPct ?? "";
    $("initial").value = q.initialPct ?? "";
    $("bcv").value = q.bcv ?? "";

    items = Array.isArray(q.items) ? [...q.items] : [];
    renderItemsChips();

    lastQuote = q;
    renderResults(q);
    saveDraft();
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function deleteFromHistory(index){
    history.splice(index,1);
    localStorage.setItem(STORAGE.history, JSON.stringify(history));
    renderHistory();
  }

  function clearHistory(){
    if(!confirm("¬øSeguro que quieres borrar todo el historial?")) return;
    history = [];
    localStorage.setItem(STORAGE.history, JSON.stringify(history));
    renderHistory();
  }

  // =========================
  // WHATSAPP
  // =========================
  function quoteToMessage(q){
    const lines = [];
    lines.push(`*${CONFIG.brandName}*`);
    lines.push(`Cotizaci√≥n`);
    lines.push(`Cliente: ${q.client}`);
    lines.push(`Fecha: ${q.date}`);
    lines.push(`Marca: ${q.brand}`);
    lines.push(``);
    lines.push(`Items:`);
    q.items.forEach((it) => lines.push(`- ${it.qty || "-"}x ${it.name}: $${money(it.total)}`));
    lines.push(``);
    lines.push(`Art√≠culos: $${money(q.totalItemsUSD)}`);
    lines.push(`Env√≠o (${money(q.shippingPct)}%): $${money(q.shippingUSD)}`);
    lines.push(`Total: *$${money(q.totalUSD)}*`);
    lines.push(`Inicial (${money(q.initialPct)}%): $${money(q.initialUSD)}`);
    lines.push(`Restante: $${money(q.remainingUSD)}`);

    const rateInfo = `${q.bcvSource || "manual"}${q.bcvUpdatedAt ? ` ‚Ä¢ ${new Date(q.bcvUpdatedAt).toLocaleString()}` : ""}`;
    lines.push(`BCV usada: Bs ${money(q.bcv)} (${rateInfo})`);
    lines.push(`Total Bs: Bs ${money(q.totalBs)}`);

    // ‚úÖ Nota anti-discusi√≥n (emprendimiento +)
    lines.push(``);
    lines.push(`üìù Nota: La tasa aplicada corresponde al momento de emisi√≥n de esta cotizaci√≥n y puede variar seg√∫n el d√≠a.`);

    return lines.join("\n");
  }

  function shareWhatsApp(q){
    if(!q){ alert("Primero calcula una cotizaci√≥n."); return; }
    const msg = encodeURIComponent(quoteToMessage(q));
    window.open(CONFIG.whatsappBase + msg, "_blank", "noopener,noreferrer");
  }

  // =========================
  // PDF
  // =========================
  function exportPDF(q){
    if(!q){ alert("Primero calcula una cotizaci√≥n."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text(CONFIG.brandName, 105, 16, {align:"center"});

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(`Cotizaci√≥n`, 105, 23, {align:"center"});

    let y = 32;
    doc.setFontSize(10);
    doc.text(`Cliente: ${q.client}`, 14, y); y += 6;
    doc.text(`Fecha: ${q.date}`, 14, y); y += 6;
    doc.text(`Marca: ${q.brand}`, 14, y); y += 8;

    doc.setFont("helvetica", "bold");
    doc.text("Items:", 14, y); y += 6;
    doc.setFont("helvetica", "normal");

    const itemLines = q.items.map(it => `‚Ä¢ ${it.qty || "-"}x ${it.name}  |  $${money(it.total)}`);
    const wrapped = doc.splitTextToSize(itemLines.join("\n"), 180);
    doc.text(wrapped, 14, y);
    y += wrapped.length * 5 + 6;

    doc.setFont("helvetica", "bold");
    doc.text(`Art√≠culos: $${money(q.totalItemsUSD)}`, 14, y); y += 6;
    doc.text(`Env√≠o (${money(q.shippingPct)}%): $${money(q.shippingUSD)}`, 14, y); y += 6;
    doc.text(`TOTAL: $${money(q.totalUSD)}`, 14, y); y += 7;

    doc.setFont("helvetica", "normal");
    doc.text(`Inicial (${money(q.initialPct)}%): $${money(q.initialUSD)}`, 14, y); y += 6;
    doc.text(`Restante: $${money(q.remainingUSD)}`, 14, y); y += 7;

    const rateInfo = `${q.bcvSource || "manual"}${q.bcvUpdatedAt ? ` ‚Ä¢ ${new Date(q.bcvUpdatedAt).toLocaleString()}` : ""}`;
    const rateLine = `BCV usada: Bs ${money(q.bcv)} (${rateInfo})`;
    doc.text(doc.splitTextToSize(rateLine, 180), 14, y); y += 10;

    doc.text(`Total Bs: Bs ${money(q.totalBs)}`, 14, y); y += 8;

    // ‚úÖ Nota anti-discusi√≥n
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    const note = "Nota: La tasa aplicada corresponde al momento de emisi√≥n de esta cotizaci√≥n y puede variar seg√∫n el d√≠a.";
    doc.text(doc.splitTextToSize(note, 180), 14, y);
    y += 10;

    doc.setFontSize(9);
    doc.text("Generado desde Cotizador Pro (PWA)", 105, 290, {align:"center"});

    doc.save(`cotizacion_${q.client.replaceAll(" ","_")}_${q.date}.pdf`);
  }

  function exportHistoryPDF(){
    if(history.length === 0){ alert("No hay historial para exportar."); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text(`${CONFIG.brandName} - Historial`, 105, 16, {align:"center"});

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);

    let y = 28;
    history.slice(0, 40).forEach((q, i) => {
      const line = `${i+1}. ${q.date} | ${q.client} | ${q.brand} | $${money(q.totalUSD)}`;
      doc.text(doc.splitTextToSize(line, 180), 14, y);
      y += 6;
      if(y > 280){ doc.addPage(); y = 20; }
    });

    doc.save("historial_cotizaciones.pdf");
  }

  // =========================
  // MINI CALCS
  // =========================
  function calcOp(a,b,op){
    if(op === "+") return a + b;
    if(op === "-") return a - b;
    if(op === "*") return a * b;
    return 0;
  }

  function calcUSD(op){
    const a = parseFloat($("usd1").value) || 0;
    const b = parseFloat($("usd2").value) || 0;
    const r = calcOp(a,b,op);
    $("usdRes").innerHTML = `<div><strong>Resultado:</strong> ${money(r)} USD</div>`;
  }

  function calcBS(op){
    const a = parseFloat($("bs1").value) || 0;
    const b = parseFloat($("bs2").value) || 0;
    const r = calcOp(a,b,op);
    const bcv = parseFloat($("bcv").value) || 1;
    $("bsRes").innerHTML = `
      <div><strong>Resultado:</strong> ${money(r)} Bs</div>
      <div class="muted">‚Üí ${money(r / bcv)} USD (BCV: ${money(bcv)})</div>
    `;
  }

  async function copyText(text){
    try{ await navigator.clipboard.writeText(String(text)); alert("Copiado ‚úÖ"); }
    catch(e){ alert("No se pudo copiar (permisos del navegador)."); }
  }

  function resetAll(){
    if(!confirm("¬øReiniciar formulario e √≠tems? (No borra historial)")) return;
    items = [];
    lastQuote = null;

    $("client").value = "";
    $("date").value = nowISODate();
    $("brand").value = "";
    $("shipping").value = "";
    $("initial").value = "";
    $("bcv").value = "";

    $("itemName").value = "";
    $("itemQty").value = "";
    $("itemPrice").value = "";
    $("itemTax").value = "";

    $("results").innerHTML = `<div class="muted">Sin cotizaci√≥n todav√≠a.</div>`;
    renderItemsChips();
    saveDraft();
  }

  // =========================
  // VISTA CLIENTE TOGGLE
  // =========================
  function setClientMode(enabled){
    document.body.classList.toggle("client", !!enabled);
    const btn = $("clientModeBtn");
    if(btn) btn.textContent = enabled ? "Salir de Modo Cliente" : "Modo Cliente";

    if(enabled){
      $("calcDetails").open = true;
      $("results").scrollIntoView({behavior:"smooth", block:"start"});
    }
    localStorage.setItem(STORAGE.mode, enabled ? "client" : "admin");
  }

  // =========================
  // EVENTS
  // =========================
  $("addItemBtn").addEventListener("click", addItem);
  $("calcBtn").addEventListener("click", calculate);
  $("pdfBtn").addEventListener("click", () => exportPDF(lastQuote));
  $("waBtn").addEventListener("click", () => shareWhatsApp(lastQuote));
  $("resetBtn").addEventListener("click", resetAll);

  $("clearHistoryBtn").addEventListener("click", clearHistory);
  $("exportHistoryBtn").addEventListener("click", exportHistoryPDF);

  $("themeToggle").addEventListener("click", () => {
    document.body.classList.toggle("dark");
    const isDark = document.body.classList.contains("dark");
    $("themeToggle").textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem(STORAGE.theme, isDark ? "dark" : "light");
  });

  $("clientModeBtn").addEventListener("click", () => {
    if(!lastQuote){
      alert("Primero calcula una cotizaci√≥n para mostrar en Modo Cliente.");
      return;
    }
    const enabled = !document.body.classList.contains("client");
    setClientMode(enabled);
    if(lastQuote) renderResults(lastQuote);
  });

  // ‚úÖ Rate buttons
  $("updateRateBtn").addEventListener("click", () => updateRate({ force: true }));
  $("useManualBtn").addEventListener("click", () => setRateStatus("Tasa: manual (editada por ti)."));

  document.addEventListener("click", (e) => {
    const usdOp = e.target?.getAttribute?.("data-usd-op");
    const bsOp  = e.target?.getAttribute?.("data-bs-op");
    if(usdOp) calcUSD(usdOp);
    if(bsOp)  calcBS(bsOp);

    const loadIdx = e.target?.getAttribute?.("data-load");
    const delIdx  = e.target?.getAttribute?.("data-del");
    const waIdx   = e.target?.getAttribute?.("data-wa");

    if(loadIdx !== null && loadIdx !== undefined) loadFromHistory(Number(loadIdx));
    if(delIdx !== null && delIdx !== undefined)  deleteFromHistory(Number(delIdx));
    if(waIdx !== null && waIdx !== undefined)    shareWhatsApp(history[Number(waIdx)]);
  });

  $("usdClearBtn").addEventListener("click", () => {
    $("usd1").value = ""; $("usd2").value = "";
    $("usdRes").innerHTML = `<div class="muted">Resultado: -</div>`;
  });
  $("bsClearBtn").addEventListener("click", () => {
    $("bs1").value = ""; $("bs2").value = "";
    $("bsRes").innerHTML = `<div class="muted">Resultado: -</div>`;
  });

  $("usdCopyBtn").addEventListener("click", () => copyText($("usdRes").innerText.trim()));
  $("bsCopyBtn").addEventListener("click", () => copyText($("bsRes").innerText.trim()));

  // =========================
  // PREMIUM MOTION polish
  // =========================
  (function premiumMotion(){
    const mainCard = document.querySelector(".card");
    if(mainCard){
      mainCard.classList.add("fade-enter");
      requestAnimationFrame(() => mainCard.classList.add("fade-enter-active"));
    }

    const tapSelectors = [".btn", ".op-btn", ".chip"];
    document.addEventListener("pointerdown", (e) => {
      const el = e.target.closest(tapSelectors.join(","));
      if(!el) return;
      el.style.filter = "brightness(.98)";
    });
    document.addEventListener("pointerup", (e) => {
      const el = e.target.closest(tapSelectors.join(","));
      if(!el) return;
      el.style.filter = "";
    });
    document.addEventListener("pointercancel", (e) => {
      const el = e.target.closest(tapSelectors.join(","));
      if(!el) return;
      el.style.filter = "";
    });

    document.documentElement.style.scrollBehavior = "smooth";
  })();

  // =========================
  // START
  // =========================
  loadDraft();
  renderHistory();
  renderItemsChips();

  // Restaurar modo guardado
  const savedMode = localStorage.getItem(STORAGE.mode);
  if(savedMode === "client"){
    setClientMode(true);
    if(lastQuote) renderResults(lastQuote);
  }

  // ‚úÖ Auto-actualizar tasa (1 vez al d√≠a)
  updateRate({ force: false });

  // =========================
  // ‚úÖ PWA: REGISTRAR SERVICE WORKER
  // =========================
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js")
      .then(() => console.log("Service Worker registrado"))
      .catch(err => console.log("SW error:", err));
  }
</script>
</body>
</html>

