<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Cotizador Pro</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Cotizador Pro">
<meta name="theme-color" content="#007AFF">

<style>
:root{
  --bg:#f4f6fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
  --line:rgba(15,23,42,.10); --primary:#007AFF; --primary2:#2D5BFF;
  --success:#22c55e; --danger:#ef4444; --shadow:0 18px 50px rgba(2,6,23,.10);
  --radius:18px; --radius2:14px;
}
body.dark{
  --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
  --line:rgba(148,163,184,.18); --shadow:0 20px 70px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial;
  background:
    radial-gradient(1000px 600px at 10% -10%, rgba(0,122,255,.20), transparent 55%),
    radial-gradient(900px 500px at 110% 10%, rgba(34,197,94,.14), transparent 55%),
    var(--bg);
  color:var(--text);
}
.container{max-width:1120px;margin:0 auto;padding:18px 14px 80px;}
header{
  position:sticky;top:0;z-index:20;backdrop-filter:blur(10px);
  background: rgba(255,255,255,.72);
  background: color-mix(in srgb, var(--bg) 75%, transparent);
  border-bottom:1px solid var(--line);
}
.header-inner{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:14px 14px;max-width:1120px;margin:0 auto;
}
.brand{display:flex;align-items:center;gap:10px;}
.logo{
  width:42px;height:42px;border-radius:14px;
  background:linear-gradient(135deg,var(--primary),var(--primary2));
  display:grid;place-items:center;color:white;font-weight:800;
  box-shadow:0 10px 30px rgba(0,122,255,.35);
}
.brand h1{margin:0;font-size:18px;letter-spacing:.2px;}
.brand .sub{font-size:12px;color:var(--muted);margin-top:2px;}
.header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.icon-btn{
  border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 88%, transparent);
  color:var(--text);
  padding:10px 12px;border-radius:14px;cursor:pointer;
  box-shadow:0 10px 24px rgba(2,6,23,.06);
  transition:.18s ease;display:flex;gap:8px;align-items:center;font-weight:700;
}
.icon-btn:hover{transform:translateY(-1px)}
.icon{font-size:16px}

.grid{
  display:grid;
  grid-template-columns:1.2fr .8fr;
  gap:14px;
  margin-top:14px;
}

/* Tablet: una columna */
@media (max-width:980px){
  .grid{ grid-template-columns:1fr; }
}

/* M√≥vil: layout tipo app (stack vertical) + orden fijo */
@media (max-width:768px){
  .grid{
    display:flex;
    flex-direction:column;
  }
  .grid > .card:nth-child(1){ order:1; }
  .grid > .card:nth-child(2){ order:2; }
  html, body{ overflow-x:hidden; }
  .card{ width:100%; }
}

.card{
  background:color-mix(in srgb, var(--card) 92%, transparent);
  border:1px solid var(--line);border-radius:var(--radius);
  box-shadow:var(--shadow);overflow:hidden;
}
.card .head{
  padding:14px 16px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--line);
}
.card .head h2{margin:0;font-size:15px;letter-spacing:.2px}
.card .content{padding:14px 16px 16px}

.row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media (max-width:520px){.row{grid-template-columns:1fr}}

.field label{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin:2px 0 6px;}
.input,select,textarea{
  width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 92%, transparent);
  color:var(--text);outline:none;transition:.15s ease;font-family:inherit;
}
textarea{min-height:84px;resize:vertical}
.input:focus,select:focus,textarea:focus{
  border-color:color-mix(in srgb, var(--primary) 55%, var(--line));
  box-shadow:0 0 0 4px rgba(0,122,255,.15);
}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
.btn{
  border:none;border-radius:14px;padding:12px 14px;cursor:pointer;font-weight:800;
  display:flex;gap:10px;align-items:center;transition:.18s ease;
}
.btn-primary{color:white;background:linear-gradient(135deg,var(--primary),var(--primary2));box-shadow:0 14px 30px rgba(0,122,255,.35);}
.btn-primary:hover{transform:translateY(-1px)}
.btn-soft{
  color:var(--text);
  background:color-mix(in srgb, var(--primary) 10%, var(--card));
  border:1px solid color-mix(in srgb, var(--primary) 25%, var(--line));
}
.btn-muted{color:var(--text);background:color-mix(in srgb, var(--card) 92%, transparent);border:1px solid var(--line);}
.btn-danger{color:white;background:linear-gradient(135deg,#ef4444,#fb7185);box-shadow:0 14px 30px rgba(239,68,68,.25);}
.btn-danger:hover{transform:translateY(-1px)}
.btn:disabled{opacity:.6;cursor:not-allowed}

.badge{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);}
hr.sep{border:none;border-top:1px dashed var(--line);margin:14px 0;}
.muted{color:var(--muted);font-size:13px;}
.small{font-size:12px;color:var(--muted);}

.item-line{display:grid;grid-template-columns:.95fr .65fr .85fr .85fr auto;gap:10px;align-items:end;}
@media (max-width:780px){.item-line{grid-template-columns:1fr 1fr}}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.chip{
  display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
  border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 92%, transparent);
  font-size:12px;
}
.chip b{font-size:12px}
.chip .x{
  width:22px;height:22px;border-radius:999px;display:grid;place-items:center;cursor:pointer;
  border:1px solid var(--line);
  background:color-mix(in srgb, #ef4444 10%, var(--card));
}
.results{padding:14px 16px}
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
@media (max-width:520px){.kpis{grid-template-columns:1fr}}
.kpi{
  border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 92%, transparent);
  border-radius:var(--radius2);padding:12px;
}
.kpi .t{font-size:12px;color:var(--muted)}
.kpi .v{font-size:18px;font-weight:900;margin-top:4px}

.table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px;}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;}
.table th{color:var(--muted);font-weight:800;font-size:12px;}

details.private{
  border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;margin-top:14px;
  background:color-mix(in srgb, var(--card) 92%, transparent);
}
details.private summary{
  list-style:none;cursor:pointer;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;
  gap:10px;font-weight:900;border-bottom:1px solid var(--line);
}
details.private summary::-webkit-details-marker{display:none}

.calcbox{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media (max-width:700px){.calcbox{grid-template-columns:1fr}}
.mini{
  border:1px solid var(--line);border-radius:var(--radius2);padding:12px;
  background:color-mix(in srgb, var(--card) 92%, transparent);
}
.mini h3{margin:0 0 8px;font-size:13px;}
.mini .mini-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.mini .mini-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
.mini .mini-out{
  margin-top:10px;font-weight:900;padding:10px;border-radius:12px;border:1px solid var(--line);
  background:color-mix(in srgb, var(--success) 10%, var(--card));
}

.history-list{display:flex;flex-direction:column;gap:10px;}
.hist{border:1px solid var(--line);background:color-mix(in srgb, var(--card) 92%, transparent);border-radius:var(--radius2);padding:12px;}
.hist-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
.hist-top b{font-size:13px;}
.hist-top .meta{font-size:12px;color:var(--muted);}
.hist-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
.hist-actions button{
  padding:9px 10px;border-radius:12px;border:1px solid var(--line);
  background:color-mix(in srgb, var(--primary) 10%, var(--card));
  cursor:pointer;font-weight:800;
}
.hist-actions .del{background:color-mix(in srgb, #ef4444 12%, var(--card));}

body.client .admin-only{display:none!important;}
body.client .grid{grid-template-columns:1fr;}
body.client .card{max-width:980px;margin:0 auto;}

/* LOGIN OVERLAY */
#loginOverlay{
  position:fixed; inset:0; z-index:9999;
  display:none; place-items:center;
  padding:18px;
  background: radial-gradient(1000px 600px at 10% -10%, rgba(0,122,255,.25), transparent 55%),
              radial-gradient(900px 500px at 110% 10%, rgba(34,197,94,.18), transparent 55%),
              rgba(2,6,23,.55);
  backdrop-filter: blur(10px);
}
#loginOverlay.show{ display:grid; }
.login-card{
  width:min(520px, 100%);
  border-radius:22px;
  border:1px solid color-mix(in srgb, var(--line) 65%, transparent);
  background:color-mix(in srgb, var(--card) 92%, transparent);
  box-shadow: 0 30px 90px rgba(0,0,0,.35);
  overflow:hidden;
}
.login-head{
  padding:16px 16px 12px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  border-bottom:1px solid var(--line);
}
.login-title{display:flex; align-items:center; gap:10px;}
.login-title .badge2{
  width:44px; height:44px; border-radius:16px;
  display:grid; place-items:center;
  background:linear-gradient(135deg,var(--primary),var(--primary2));
  color:#fff; font-weight:900;
  box-shadow:0 10px 30px rgba(0,122,255,.35);
}
.login-title h3{margin:0; font-size:15px;}
.login-title .p{margin:2px 0 0; font-size:12px; color:var(--muted);}
.login-body{ padding:14px 16px 16px; }
.login-actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
.login-hint{
  margin-top:10px;
  font-size:12px; color:var(--muted);
  border-top:1px dashed var(--line);
  padding-top:10px;
}
.pill{
  display:inline-flex; align-items:center; gap:6px;
  border:1px solid var(--line);
  padding:6px 10px;
  border-radius:999px;
  font-weight:800;
  background:color-mix(in srgb, var(--card) 92%, transparent);
}
/* =========================
   MOBILE FIX PACK (Header + Botones + Tablas)
========================= */

/* Evita zoom en iOS al tocar inputs (Safari zoom si font-size < 16px) */
input, select, textarea { font-size: 16px; }

/* Tap targets c√≥modos */
button, .btn, .icon-btn { min-height: 44px; }

/* ===== Fix Header m√≥vil (evita que se rompa) ===== */
@media (max-width:520px){
  .header-inner{
    gap:10px;
    align-items:flex-start;
  }

  /* En m√≥vil: acciones con scroll horizontal en vez de wrap */
  .header-actions{
    flex-wrap:nowrap;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    max-width:52vw;
    padding-bottom:4px;
  }
  .header-actions::-webkit-scrollbar{ display:none; }

  .brand h1{ font-size:16px; }
  .brand .sub{ font-size:11px; }
}

/* ===== Botones full-width en m√≥vil ===== */
@media (max-width:520px){
  .actions{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }
  .btn{
    width:100%;
    justify-content:center;
  }
}

/* ===== Tablas responsivas (no se salen en m√≥vil) ===== */
.table-wrap{
  width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  border-radius:14px;
}

@media (max-width:520px){
  .table{ font-size:12px; }
  .table th,.table td{ padding:8px 6px; }
}

/* ===== MOBILE (APP BANKING STYLE) ===== */
@media (max-width: 768px){

  .container{ padding: 12px !important; }

  .card{
    padding: 0 !important;
    border-radius: 14px !important;
    margin-bottom: 12px !important;
  }
  .card .head{ padding: 12px 12px !important; }
  .card .content{ padding: 12px 12px 14px !important; }

  .brand h1{ font-size: 16px !important; }
  .brand .sub{ font-size: 11px !important; }

  .card .head h2{ font-size: 14px !important; }

  .field label{
    font-size: 11px !important;
    margin: 2px 0 6px !important;
  }

  /* iOS: mantener 16px evita zoom */
  input, select, textarea{
    font-size: 16px !important;
    padding: 8px 10px !important;
    border-radius: 12px !important;
  }
  input, select{ height: 40px !important; }

  .btn, .icon-btn, button{
    min-height: 40px !important;
    border-radius: 12px !important;
    padding: 10px 12px !important;
    font-size: 14px !important;
  }

  .row{ grid-template-columns: 1fr !important; gap: 10px !important; }

  .item-line{
    grid-template-columns: 1fr 1fr !important;
    gap: 10px !important;
  }

  .kpis{ grid-template-columns: 1fr !important; gap: 10px !important; }
  .kpi{ padding: 10px !important; }
  .kpi .v{ font-size: 17px !important; }

  details.private summary{ padding: 12px 12px !important; }

  .mini{ padding: 10px !important; }
  .mini h3{ font-size: 13px !important; }
  .mini .mini-actions{ gap: 8px !important; }
  .mini .mini-out{ padding: 10px !important; font-size: 18px !important; }

  .table{ font-size: 12px !important; }
  .table th,.table td{ padding: 8px 6px !important; }
}


/* ===== FIX PRO iOS/Android (no overflow, safe-area, tablas) ===== */
html, body { max-width: 100%; overflow-x: hidden; }
.container{
  width: 100%;
  max-width: 1120px;
  padding-left: calc(14px + env(safe-area-inset-left));
  padding-right: calc(14px + env(safe-area-inset-right));
  padding-bottom: calc(80px + env(safe-area-inset-bottom));
}
header{ padding-top: env(safe-area-inset-top); }
.table-wrap{
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
table{ width: 100%; }
input, select, textarea, button{ max-width: 100%; }
@supports not (background: color-mix(in srgb, white 50%, transparent)){
  header{ background: rgba(255,255,255,.72); }
  body.dark header{ background: rgba(15,23,42,.72); }
}
/* Feeling tipo app */
*{ -webkit-tap-highlight-color: transparent; }
button, .btn{ touch-action: manipulation; }

</style>
</head>

<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" aria-hidden="true">
  <div class="login-card">
    <div class="login-head">
      <div class="login-title">
        <div class="badge2">CP</div>
        <div>
          <h3>Acceso ‚Ä¢ Cotizador Pro</h3>
          <div class="p">Inicia sesi√≥n para usar tu espacio de trabajo</div>
        </div>
      </div>
      <span class="pill" id="loginStatus">üîí Protegido</span>
    </div>

    <div class="login-body">

      <!-- PREVIEW (AVATAR SIN FOTO) -->
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
        <div id="loginAvatar" style="
          width:46px;height:46px;border-radius:16px;
          display:grid;place-items:center;
          font-weight:900;color:white;
          background:linear-gradient(135deg,var(--primary),var(--primary2));
          box-shadow:0 10px 30px rgba(0,122,255,.25);
        ">CP</div>
        <div>
          <div id="loginName" style="font-weight:900;">‚Äî</div>
          <div id="loginRole" class="small">‚Äî</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Usuario</label>
          <select id="loginUser" class="input"></select>
        </div>
        <div class="field">
          <label>Contrase√±a</label>
          <input class="input" id="loginPass" type="password" placeholder="Tu contrase√±a" autocomplete="current-password" />
        </div>
      </div>

      <div class="login-actions">
        <button class="btn btn-primary" id="loginBtn">üîë Entrar</button>
        <button class="btn btn-muted" id="loginClearBtn" type="button">üßπ Limpiar</button>
      </div>

      <div class="login-hint">
        <div><b>Tip:</b> Cada usuario tiene su <b>historial y borrador</b> separados.</div>
      </div>
    </div>
  </div>
</div>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">CP</div>
      <div>
        <h1 id="brandTitle">Cotizador Pro</h1>
        <div class="sub">Cotiza r√°pido ‚Ä¢ PDF ‚Ä¢ WhatsApp ‚Ä¢ Historial</div>
      </div>
    </div>
    <div class="header-actions">
      <div id="headerUserAvatar" style="
        width:30px;height:30px;border-radius:10px;
        display:none;place-items:center;
        font-weight:900;color:white;font-size:12px;
        background:linear-gradient(135deg,var(--primary),var(--primary2));
        border:1px solid var(--line);
      ">CP</div>
      <span class="badge" id="activeUserBadge" title="Usuario activo">‚Äî</span>
      <button class="icon-btn" id="logoutBtn" title="Cerrar sesi√≥n"><span class="icon">üö™</span> Salir</button>
      <button class="icon-btn" id="clientModeBtn" title="Alternar Modo Cliente"><span class="icon">üë§</span> Modo Cliente</button>
      <button class="icon-btn" id="themeToggle" title="Modo claro/oscuro"><span class="icon">üåô</span></button>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="head">
        <h2>Datos de la cotizaci√≥n</h2>
        </div>
      <div class="content">
        <div class="row">
          <div class="field">
            <label>Cliente</label>
            <input class="input" id="client" placeholder="Nombre del cliente" />
          </div>
          <div class="field">
            <label>Fecha</label>
            <input class="input" id="date" type="date" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Tienda</label>
            <select id="brand" class="input">
              <option value="">Selecciona‚Ä¶</option>
              <option value="Shein">Shein</option>
              <option value="Temu">Temu</option>
              <option value="AliExpress">AliExpress</option>
            </select>
          </div>

          <div class="field">
            <label>Moneda de cotizaci√≥n</label>
            <select id="baseCurrency" class="input">
              <option value="USD">$ USD</option>
              <option value="EUR">‚Ç¨ EUR</option>
            </select>
          </div>

          <div class="field">
            <label>
              Tasa (USD‚ÜíVES)
              <span class="small" style="display:flex;gap:8px;align-items:center;">
                <span class="badge" id="rateStateUsd">Manual</span>
                <button class="icon-btn" id="rateBtn" style="padding:6px 10px;border-radius:12px;font-weight:800" type="button">‚Üª Actualizar</button>
              </span>
            </label>
            <input class="input" id="bcv" type="number" step="0.01" placeholder="Ej: 38.50" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>
              Tasa (EUR‚ÜíVES)
              <span class="small" style="display:flex;gap:8px;align-items:center;">
                <span class="badge" id="rateStateEur">Manual</span>
                <button class="icon-btn" id="rateEurBtn" style="padding:6px 10px;border-radius:12px;font-weight:800" type="button">‚Üª Actualizar ‚Ç¨</button>
              </span>
            </label>
            <input class="input" id="bcv_eur" type="number" step="0.01" placeholder="Ej: 41.20" />
          </div>
        </div>

<hr class="sep">

        <div class="item-line admin-only">
          <div class="field">
            <label>Art√≠culos/Servicios</label>
            <select id="itemType" class="input">
              <option value="Ropa">Ropa</option>
              <option value="Accesorios">Accesorios</option>
              <option value="Otros">Otros</option>
            </select>
          </div>

          <div class="field">
            <label>Cantidad</label>
            <input class="input" id="itemQty" type="number" step="1" min="0" placeholder="0" />
          </div>

          <div class="field">
            <label>Precio (Moneda base)</label>
            <input class="input" id="itemPrice" type="number" step="0.01" min="0" placeholder="Ej: 100 USD" />
          </div>

          <div class="field">
            <label>Impuesto (Moneda base)</label>
            <input class="input" id="itemTax" type="number" step="0.01" min="0" placeholder="0.00" />
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <button class="btn btn-soft" id="addItemBtn" style="width:100%;justify-content:center" type="button">‚ûï Agregar</button>
          </div>
        </div>

        <div class="chips admin-only" id="itemsChips"></div>

        <hr class="sep">

        <div class="row admin-only">
          <div class="field">
            <label>Env√≠o Internacional (%)</label>
            <input class="input" id="shipping" type="number" step="0.01" min="0" placeholder="Ej: 10" />
          </div>

          <div class="field">
            <label>Inicial (%)</label>
            <input class="input" id="initial" type="number" step="0.01" min="0" max="100" placeholder="Ej: 30" />
            <div class="small" id="initialPreview" style="margin-top:6px;">Inicial estimada: ‚Äî</div>
          </div>
        </div>

        <div class="actions admin-only">
          <button class="btn btn-primary" id="calcBtn" type="button">üßÆ Calcular</button>
          <button class="btn btn-muted" id="resetBtn" type="button">‚ôªÔ∏è Reiniciar</button>
        </div>

        <details class="private admin-only" id="privateDetails">
          <summary>
            <span>üîí Ajustes Privados</span>
            <button class="btn btn-muted" id="privateToggleBtn" type="button" style="padding:8px 10px">Abrir Ajustes Privados</button>
          </summary>
          <div class="content">
            <div class="calcbox">
              <div class="mini">
                <h3>Mini Calculadora 1</h3>
                <div class="mini-row">
                  <div class="field">
                    <label>Monto A</label>
                    <input class="input" id="m1a" type="number" step="0.01">
                  </div>
                  <div class="field">
                    <label>Monto B</label>
                    <input class="input" id="m1b" type="number" step="0.01">
                  </div>
                </div>
                <div class="mini-actions">
                  <button class="btn btn-soft" id="m1plus" type="button">‚ûï</button>
                  <button class="btn btn-soft" id="m1minus" type="button">‚ûñ</button>
                  <button class="btn btn-soft" id="m1mul" type="button">‚úñÔ∏è</button>
                </div>
                <div class="mini-out" id="m1out">0.00</div>
              </div>

              <div class="mini">
                <h3>Mini Calculadora 2 (Bs ‚Üí $ seg√∫n BCV)</h3>
                <div class="mini-row">
                  <div class="field">
                    <label>Monto Bs A</label>
                    <input class="input" id="m2a" type="number" step="0.01" placeholder="0.00">
                  </div>
                  <div class="field">
                    <label>Monto USD B</label>
                    <input class="input" id="m2b" type="number" step="0.01" placeholder="0.00">
                  </div>
                </div>
                <div class="mini-actions">
                  <button class="btn btn-soft" id="m2plus" type="button">‚ûï</button>
                  <button class="btn btn-soft" id="m2minus" type="button">‚ûñ</button>
                  <button class="btn btn-soft" id="m2mul" type="button">‚úñÔ∏è</button>
                </div>
                <div class="mini-out" id="m2out">$0.00</div>
              </div>

              <div class="mini" style="grid-column:1 / -1;">
                <h3>M√©todos de pago (se env√≠an por WhatsApp)</h3>
                <div class="row">
                  <div class="field">
                    <label>Bol√≠vares (Bs)</label>
                    <textarea id="pay_bs" class="input" placeholder="Ej: Pago M√≥vil, Transferencia"></textarea>
                  </div>
                  <div class="field">
                    <label>D√≥lares (USD)</label>
                    <textarea id="pay_usd" class="input" placeholder="Ej: Efectivo, Zinli, Wally"></textarea>
                  </div>
                </div>
                <div class="row">
                  <div class="field">
                    <label>Pesos Colombianos (COP)</label>
                    <textarea id="pay_cop" class="input" placeholder="Ej: Bancolombia, Nequi, Nu"></textarea>
                  </div>
                  <div class="field">
                    <label>USDT</label>
                    <textarea id="pay_usdt" class="input" placeholder="Ej: Binance Pay"></textarea>
                  </div>
                </div>
                <div class="small">Tip: separa m√©todos por coma para que salga limpio en el mensaje.</div>
              </div>

              <div class="mini" style="grid-column:1 / -1;">
                <h3>T√©rminos y condiciones (se env√≠an por WhatsApp)</h3>
                <div class="field">
                  <label>Texto (una condici√≥n por l√≠nea)</label>
                  <textarea id="terms_text" class="input" placeholder="Escribe aqu√≠ tus t√©rminos..."></textarea>
                </div>
                <div class="small">Cada l√≠nea se enviar√° como un punto ‚Ä¢ en WhatsApp.</div>
              </div>

              <!-- CAMBIAR MI CONTRASE√ëA -->
              <div class="mini" style="grid-column:1 / -1;">
                <h3>üîê Cambiar mi contrase√±a</h3>
                <div class="row">
                  <div class="field">
                    <label>Contrase√±a actual</label>
                    <input id="pw_current" class="input" type="password" placeholder="Actual">
                  </div>
                  <div class="field">
                    <label>Nueva contrase√±a</label>
                    <input id="pw_new" class="input" type="password" placeholder="Nueva">
                  </div>
                </div>
                <div class="row">
                  <div class="field">
                    <label>Confirmar nueva contrase√±a</label>
                    <input id="pw_new2" class="input" type="password" placeholder="Repite la nueva">
                  </div>
                  <div class="field">
                    <label>&nbsp;</label>
                    <button id="pw_save" class="btn btn-primary" style="width:100%;justify-content:center;" type="button">üíæ Guardar</button>
                  </div>
                </div>
                <div class="small" id="pw_msg" style="margin-top:8px;">‚Äî</div>
              </div>

              <!-- GESTI√ìN DE USUARIOS -->
              <div class="mini" style="grid-column:1 / -1;">
                <h3>üë• Gesti√≥n de usuarios</h3>
                <div class="small" style="margin-bottom:10px;">
                  Solo el <b>Admin Maestro</b> puede crear/eliminar usuarios. Se guardan en este dispositivo.
                </div>

                <div class="row">
                  <div class="field">
                    <label>Usuario (ID sin espacios)</label>
                    <input id="nu_user" class="input" placeholder="Ej: maria / admin2" />
                    <div class="small">Tip: usa min√∫sculas, sin espacios. Ej: <b>maria</b></div>
                  </div>
                  <div class="field">
                    <label>Nombre visible</label>
                    <input id="nu_name" class="input" placeholder="Ej: Mar√≠a (Admin 3)" />
                  </div>
                </div>

                <div class="row">
                  <div class="field">
                    <label>Contrase√±a</label>
                    <input id="nu_pass" class="input" type="password" placeholder="M√≠nimo 4 caracteres" />
                  </div>
                  <div class="field">
                    <label>Rol</label>
                    <select id="nu_role" class="input">
                      <option value="admin">Admin</option>
                      <option value="superadmin">Admin Maestro</option>
                    </select>
                    <div class="small">Recomendado: solo 1 Admin Maestro.</div>
                  </div>
                </div>

                <div class="actions" style="margin-top:10px;">
                  <button id="nu_add" class="btn btn-primary" type="button">‚ûï Crear usuario</button>
                  <button id="nu_refresh" class="btn btn-muted" type="button">üîÑ Actualizar lista</button>
                  <button id="nu_reset_all" class="btn btn-danger" type="button">üß® Reset usuarios</button>
                </div>

                <div class="small" id="nu_msg" style="margin-top:8px;">‚Äî</div>

                <hr class="sep">

                <div style="overflow:auto;">
                  <div class="table-wrap">
<table class="table" style="min-width:680px;">
                    <thead>
                      <tr>
                        <th>Usuario</th>
                        <th>Nombre</th>
                        <th>Rol</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="usersTableBody">
                      <tr><td colspan="4" class="muted">‚Äî</td></tr>
                    </tbody>
                  </table>
</div>
                </div>

                <hr class="sep">

                <div class="mini" style="margin-top:10px;">
                  <h3>üì¶ Exportar / Importar usuarios</h3>
                  <div class="small" style="margin-bottom:10px;">
                    √ötil para pasar usuarios a otro dispositivo. Incluye usuarios creados + contrase√±as guardadas.
                  </div>

                  <div class="actions">
                    <button id="ex_users" class="btn btn-soft" type="button">‚¨áÔ∏è Exportar</button>
                    <button id="ex_copy" class="btn btn-muted" type="button">üìã Copiar</button>
                    <button id="im_users" class="btn btn-primary" type="button">‚¨ÜÔ∏è Importar</button>
                    <button id="im_replace" class="btn btn-danger" type="button">üß® Reemplazar</button>
                  </div>

                  <div class="field" style="margin-top:10px;">
                    <label>Datos (JSON)</label>
                    <textarea id="users_json" class="input" placeholder="Aqu√≠ aparecer√° el JSON al exportar, o p√©galo aqu√≠ para importar..."></textarea>
                  </div>

                  <div class="small" id="users_xmsg" style="margin-top:8px;">‚Äî</div>
                </div>
              </div>

            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card" id="resultsCard">
      <div class="head">
        <h2>Resultado</h2>
        <span class="badge" id="modeBadge">Admin</span>
      </div>

      <details open id="calcDetails">
        <summary class="muted" style="padding:10px 16px; cursor:pointer; border-bottom:1px solid var(--line); list-style:none;">
          Ver / Ocultar detalles
        </summary>
        <div class="results" id="results">
          <div class="muted">Sin cotizaci√≥n todav√≠a.</div>
        </div>
      </details>

      <div class="content">
        <div class="actions" style="margin-top:0">
          <button class="btn btn-soft" id="pdfBtn" type="button">üìÑ PDF</button>
          <button class="btn btn-soft" id="waBtn" type="button">üì≤ WhatsApp</button>
        </div>

        <hr class="sep">

        <div class="head" style="border:0;padding:0 0 10px">
          <h2>Historial</h2>
          <button class="btn btn-danger admin-only" id="clearHistoryBtn" type="button">üóëÔ∏è Borrar</button>
        </div>
        <div class="history-list" id="historyList"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){

  /* ===========================
     AUTH PRO + MULTIUSUARIO + CRUD USERS (SIN FOTOS)
  =========================== */

  const DEFAULT_USERS = {
    Gustavo: {
      pass: "0579",
      role: "superadmin",
      avatar: "GU",
      name: "Gustavo (Administrador 1)"
    },
    Alexandra: {
      pass: "2015",
      role: "admin",
      avatar: "AX",
      name: "Alexandra (Administrador 2)"
    }
  };

  const ACTIVE_USER_KEY = "cotizador_active_user_v2";
  const USER_STORE_KEY  = "cotizador_users_v2";
  const PASS_STORE_KEY  = "cotizador_pass_v2";
const PASSHASH_STORE_KEY = "cotizador_passhash_v3"; // { userId: { salt:"", hash:"", it:200000 } }

function loadPassHashStore(){ return parseSafe(localStorage.getItem(PASSHASH_STORE_KEY) || "{}", {}); }
function savePassHashStore(obj){ localStorage.setItem(PASSHASH_STORE_KEY, JSON.stringify(obj||{})); }

async function pbkdf2Hash(pass, saltB64, iterations=200000){
  const enc = new TextEncoder();
  const passKey = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveBits"]);
  const salt = Uint8Array.from(atob(saltB64), c=>c.charCodeAt(0));
  const bits = await crypto.subtle.deriveBits({ name:"PBKDF2", hash:"SHA-256", salt, iterations }, passKey, 256);
  const out = new Uint8Array(bits);
  let bin = "";
  out.forEach(b=>{ bin += String.fromCharCode(b); });
  return btoa(bin);
}

function makeSaltB64(){
  const salt = new Uint8Array(16);
  crypto.getRandomValues(salt);
  let bin = "";
  salt.forEach(b=>{ bin += String.fromCharCode(b); });
  return btoa(bin);
}

// Verificaci√≥n con compatibilidad hacia atr√°s:
// - Si existe hash -> valida contra hash
// - Si NO existe hash -> valida contra password plano y MIGRA a hash al entrar
async function verifyAndMaybeMigratePassword(userId, passPlain){
  const USERS = getUsers();
  const storedPlain = String(USERS[userId]?.pass || "");
  const hs = loadPassHashStore();
  const rec = hs[userId];

  if(rec && rec.salt && rec.hash){
    const calc = await pbkdf2Hash(passPlain, rec.salt, rec.it || 200000);
    return calc === rec.hash;
  }

  // fallback legacy (plano)
  const ok = passPlain === storedPlain;
  if(ok && passPlain){
    const salt = makeSaltB64();
    const hash = await pbkdf2Hash(passPlain, salt, 200000);
    hs[userId] = { salt, hash, it: 200000 };
    savePassHashStore(hs);

    // borrar pass plano guardado (si existe en PASS_STORE)
    const ps = loadPassStore();
    if(ps && ps[userId]){
      delete ps[userId];
      savePassStore(ps);
    }
  }
  return ok;
}

  const LOCK_STORE_KEY  = "cotizador_lock_v2";

  const INACTIVITY_MINUTES = 15;
  let inactivityTimer = null;

  const $ = (id)=>document.getElementById(id);

  // ‚úÖ Bind seguro: evita que el proyecto se rompa si un elemento no existe
  function on(id, evt, fn){
    const el = $(id);
    if(!el) return false;
    el.addEventListener(evt, fn);
    return true;
  }
  function click(id, fn){
    const el = $(id);
    if(!el) return false;
    el.onclick = fn;
    return true;
  }


  function resetInactivityTimer(){
    if(inactivityTimer) clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(()=>{
      if(localStorage.getItem(ACTIVE_USER_KEY)){
        alert("Sesi√≥n cerrada por inactividad.");
        localStorage.removeItem(ACTIVE_USER_KEY);
        location.reload();
      }
    }, INACTIVITY_MINUTES * 60 * 1000);
  }
  ["click","mousemove","keydown","scroll","touchstart"].forEach(evt=>{
    window.addEventListener(evt, resetInactivityTimer, { passive:true });
  });

  function parseSafe(v, fallback){
    try{
      const parsed = JSON.parse(v);
      return (parsed === null || parsed === undefined) ? fallback : parsed;
    }catch{
      return fallback;
    }
  }

  function loadUserStore(){ return parseSafe(localStorage.getItem(USER_STORE_KEY) || "{}", {}); }
  function saveUserStore(obj){ localStorage.setItem(USER_STORE_KEY, JSON.stringify(obj||{})); }

  function loadPassStore(){ return parseSafe(localStorage.getItem(PASS_STORE_KEY) || "{}", {}); }
  function savePassStore(obj){ localStorage.setItem(PASS_STORE_KEY, JSON.stringify(obj||{})); }

  function loadLockStore(){ return parseSafe(localStorage.getItem(LOCK_STORE_KEY) || "{}", {}); }
  function saveLockStore(obj){ localStorage.setItem(LOCK_STORE_KEY, JSON.stringify(obj||{})); }

  function makeAvatarFromUser(user){
    const u = String(user||"").trim().toUpperCase();
    if(u.length >= 2) return u.slice(0,2);
    if(u.length === 1) return u + "X";
    return "CP";
  }

  function getUsers(){
    const custom = loadUserStore() || {};     // { userId: {name, role, avatar} }
    const passStore = loadPassStore() || {}; // { userId: "pass" }

    const users = JSON.parse(JSON.stringify(DEFAULT_USERS));

    Object.keys(custom).forEach(u=>{
      users[u] = Object.assign(
        { pass:"", role:"admin", avatar: makeAvatarFromUser(u), name:u },
        custom[u] || {}
      );
    });

    Object.keys(passStore).forEach(u=>{
      if(users[u]) users[u].pass = String(passStore[u] || "");
    });

    Object.keys(users).forEach(u=>{
      users[u].name = users[u].name || u;
      users[u].avatar = users[u].avatar || makeAvatarFromUser(u);
    });

    return users;
  }

  function setActiveUser(u){
    localStorage.setItem(ACTIVE_USER_KEY, u);
    updateActiveUserBadge();
  }
  function getActiveUser(){
    const u = localStorage.getItem(ACTIVE_USER_KEY);
    const USERS = getUsers();
    return (u && USERS[u]) ? u : null;
  }

  function updateActiveUserBadge(){
    const USERS = getUsers();
    const u = getActiveUser();
    const el = $("activeUserBadge");
    const av = $("headerUserAvatar");
    if(!el) return;

    if(!u){
      el.textContent = "‚Äî";
      if(av) av.style.display = "none";
      return;
    }

    el.textContent = "üëë " + (USERS[u].name || u);
    if(av){
      av.textContent = USERS[u].avatar || makeAvatarFromUser(u);
      av.style.display = "grid";
    }
  }

  // Lockout: 5 intentos -> 10 min
  function isLocked(user){
    const locks = loadLockStore();
    const until = locks?.[user]?.until || 0;
    return Date.now() < until;
  }
  function lockMessage(user){
    const locks = loadLockStore();
    const until = locks?.[user]?.until || 0;
    const sec = Math.max(0, Math.ceil((until - Date.now()) / 1000));
    const mm = String(Math.floor(sec/60)).padStart(2,"0");
    const ss = String(sec%60).padStart(2,"0");
    return `üîí Bloqueado ${mm}:${ss}`;
  }
  function registerFail(user){
    const locks = loadLockStore();
    if(!locks[user]) locks[user] = { fails:0, until:0 };
    locks[user].fails++;
    if(locks[user].fails >= 5){
      locks[user].until = Date.now() + (10 * 60 * 1000);
      locks[user].fails = 0;
    }
    saveLockStore(locks);
  }
  function clearFails(user){
    const locks = loadLockStore();
    if(locks[user]){
      locks[user].fails = 0;
      locks[user].until = 0;
      saveLockStore(locks);
    }
  }

  // Login UI
  function buildLoginOptions(){
    const USERS = getUsers();
    const sel = $("loginUser");
    if(!sel) return;

    const current = sel.value;
    sel.innerHTML = "";
    Object.keys(USERS).sort().forEach(u=>{
      const opt = document.createElement("option");
      opt.value = u;
      opt.textContent = USERS[u].name || u;
      sel.appendChild(opt);
    });
    if(current && USERS[current]) sel.value = current;
  }

  function updateLoginPreview(){
    const USERS = getUsers();
    const sel = $("loginUser");
    const u = sel?.value;
    const info = USERS[u] || {};
    if($("loginAvatar")) $("loginAvatar").textContent = info.avatar || makeAvatarFromUser(u);
    if($("loginName")) $("loginName").textContent = info.name || u || "‚Äî";
    if($("loginRole")) $("loginRole").textContent = info.role === "superadmin" ? "Admin Maestro" : "Admin";
  }

  function showLogin(msg){
    const ov = $("loginOverlay");
    if(!ov) return;
    ov.classList.add("show");
    ov.setAttribute("aria-hidden","false");

    buildLoginOptions();
    updateLoginPreview();
    if($("loginPass")) $("loginPass").value = "";

    if(msg){
      $("loginStatus").textContent = msg;
    }else{
      $("loginStatus").textContent = "üîí Protegido";
    }
  }

  function hideLogin(){
    const ov = $("loginOverlay");
    if(!ov) return;
    ov.classList.remove("show");
    ov.setAttribute("aria-hidden","true");
  }

  async function doLogin(){
  const USERS = getUsers();
  const user = $("loginUser")?.value;
  const pass = ($("loginPass")?.value || "").trim();

  if(!user || !USERS[user]){
    alert("Selecciona un usuario v√°lido.");
    return;
  }

  if(isLocked(user)){
    $("loginStatus").textContent = lockMessage(user);
    return;
  }

  try{
    const ok = await verifyAndMaybeMigratePassword(user, pass);
    if(!ok){
      registerFail(user);
      $("loginStatus").textContent = "‚ùå Contrase√±a incorrecta";
      return;
    }
  }catch(err){
    console.error(err);
    $("loginStatus").textContent = "‚ö†Ô∏è Error validando la contrase√±a.";
    return;
  }

  clearFails(user);
  setActiveUser(user);
  hideLogin();
  resetInactivityTimer();

  // recargar por user scoped data
  location.reload();
}

function doLogout(
){
    if(!confirm("¬øCerrar sesi√≥n?")) return;
    localStorage.removeItem(ACTIVE_USER_KEY);
    location.reload();
  }

  // Tema
  const THEME_KEY = "cotizador_theme_v2";
  function applyTheme(){
    const t = localStorage.getItem(THEME_KEY) || "light";
    document.body.classList.toggle("dark", t === "dark");
    const btn = $("themeToggle");
    if(btn){
      btn.innerHTML = (t === "dark") ? '<span class="icon">‚òÄÔ∏è</span>' : '<span class="icon">üåô</span>';
    }
  }
  function toggleTheme(){
    const isDark = document.body.classList.contains("dark");
    localStorage.setItem(THEME_KEY, isDark ? "light" : "dark");
    applyTheme();
  }

  /* ===========================
     COTIZADOR
  =========================== */

  const DEFAULT_SHIPPING_PCT = 10;
  const DEFAULT_INITIAL_PCT = 30;

  let items = [];
  let history = [];
  let lastQuote = null;

  const STORAGE = {
    draft_u: null,
    history_u: null,
    last_quote_u: null,
    mode_u: null,
    payments_u: null,
    terms_u: null
  };

  function initStorageKeys(){
    const u = getActiveUser() || "anon";
    STORAGE.draft_u = `cotizador_draft_v2_${u}`;
    STORAGE.history_u = `cotizador_history_v2_${u}`;
    STORAGE.last_quote_u = `cotizador_last_quote_v2_${u}`;
    STORAGE.mode_u = `cotizador_mode_v2_${u}`;
    STORAGE.payments_u = `cotizador_payments_v2_${u}`;
    STORAGE.terms_u = `cotizador_terms_v2_${u}`;
  }

  function fmt(n){
    const x = Number(n || 0);
    return x.toLocaleString("en-US", { minimumFractionDigits:2, maximumFractionDigits:2 });
  }

  function sym(cur){
    return cur === "EUR" ? "‚Ç¨" : "$";
  }
  function fmtMoney(n, cur){
    return sym(cur) + fmt(n);
  }
  function fmtPct(n){
    const x = Number(n || 0);
    return (Math.round(x * 100) / 100).toString();
  }
  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function clamp(v, a, b){
    v = Number(v || 0);
    if(isNaN(v)) v = 0;
    return Math.min(b, Math.max(a, v));
  }
  function nowISODate(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  // fecha/hora Venezuela (UTC-4)
  function nowDateTimeVE(){
    const d = new Date(Date.now() - (4 * 60 * 60 * 1000));
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,"0");
    const day = String(d.getUTCDate()).padStart(2,"0");
    const hh = String(d.getUTCHours()).padStart(2,"0");
    const mm = String(d.getUTCMinutes()).padStart(2,"0");
    return `${y}-${m}-${day} ${hh}:${mm} (VE)`;
  }

  // Modo cliente
  function setClientMode(on){
    document.body.classList.toggle("client", !!on);
    $("modeBadge").textContent = on ? "Cliente" : "Admin";
    localStorage.setItem(STORAGE.mode_u, on ? "client" : "admin");
    const b = $("clientModeBtn");
    if(b){
      b.innerHTML = on ? '<span class="icon">üßë‚Äçüíº</span> Modo Admin' : '<span class="icon">üë§</span> Modo Cliente';
    }
  }

  function updatePrivateToggleText(){
    const det = $("privateDetails");
    const btn = $("privateToggleBtn");
    if(!det || !btn) return;
    btn.textContent = det.open ? "Cerrar Ajustes Privados" : "Abrir Ajustes Privados";
  }

  // Rate (USD -> VES)
  async function updateRate({force=false}={}){
    const badge = $("rateStateUsd");
    const input = $("bcv");
    if(!badge || !input) return;

    if(!force && input.value){
      badge.textContent = "Manual";
      return;
    }

    try{
      badge.textContent = "Buscando‚Ä¶";
      // Fuente referencial (no oficial BCV)
      const res = await fetch("https://open.er-api.com/v6/latest/USD", { cache:"no-store" });
      const data = await res.json();
      const rate = data?.rates?.VES;
      if(rate){
        input.value = String(Math.round(rate * 100) / 100);
        badge.textContent = "Referencial";
      }else{
        badge.textContent = "Manual";
      }
    }catch{
      badge.textContent = "Manual";
    }
  }

  
  // Rate (EUR -> VES)
  async function updateRateEUR({force=false}={}){
    const badge = $("rateStateEur");
    const input = $("bcv_eur");
    if(!badge || !input) return;

    if(!force && input.value){
      badge.textContent = "Manual";
      return;
    }

    try{
      badge.textContent = "Buscando‚Ä¶";
      // Fuente referencial (no oficial BCV)
      const res = await fetch("https://open.er-api.com/v6/latest/EUR", { cache:"no-store" });
      const data = await res.json();
      const rate = data?.rates?.VES;
      if(rate){
        input.value = String(Math.round(rate * 100) / 100);
        badge.textContent = "Referencial";
      }else{
        badge.textContent = "Manual";
      }
    }catch{
      badge.textContent = "Manual";
    }
  }

// Draft
  function saveDraft(){
    const draft = {
      client: $("client")?.value || "",
      date: $("date")?.value || "",
      brand: $("brand")?.value || "",
      bcv: $("bcv")?.value || "",
      baseCurrency: $("baseCurrency")?.value || "USD",
      bcv_eur: $("bcv_eur")?.value || "",
      shipping: $("shipping")?.value || "",
      initial: $("initial")?.value || "",
      items
    };
    localStorage.setItem(STORAGE.draft_u, JSON.stringify(draft));
  }

  function loadDraft(){
    const d = parseSafe(localStorage.getItem(STORAGE.draft_u) || "null", null);
    if(!d) return;
    try{
      $("client").value = d.client ?? "";
      $("date").value = d.date ?? nowISODate();
      $("brand").value = d.brand ?? "";
      $("bcv").value = d.bcv ?? "";
      if($("baseCurrency")) $("baseCurrency").value = d.baseCurrency ?? "USD";
      if($("bcv_eur")) $("bcv_eur").value = d.bcv_eur ?? "";
      $("shipping").value = d.shipping ?? "";
      $("initial").value = d.initial ?? "";
      items = Array.isArray(d.items) ? d.items : [];
    }catch(_){}
  }

  function ensureDefaultInitialPct(){
    if(!$("initial").value) $("initial").value = DEFAULT_INITIAL_PCT;
    if(!$("shipping").value) $("shipping").value = DEFAULT_SHIPPING_PCT;
    if(!$("date").value) $("date").value = nowISODate();
  }

  // Items
  function updateAddBtn(){
    $("addItemBtn").disabled = !$("brand").value;
  }


  function refreshCurrencyUI(){
    const base = $("baseCurrency")?.value || "USD";
    const price = $("itemPrice");
    const tax = $("itemTax");
    if(price) price.placeholder = base === "EUR" ? "Ej: 100 EUR" : "Ej: 100 USD";
    if(tax) tax.placeholder = base === "EUR" ? "0.00 EUR" : "0.00 USD";
  }

  function addItem(){
    const store = $("brand").value;
    const type = $("itemType").value || "Otros";
    const qty = Number($("itemQty").value || 0);
    const price = Number($("itemPrice").value || 0);
    const tax = Number($("itemTax").value || 0);


    const base = $("baseCurrency")?.value || "USD";
    if(!store){ alert("Selecciona una Tienda antes de agregar art√≠culos."); $("brand").focus(); return; }
    if(price < 0 || tax < 0 || qty < 0){ alert("Valores inv√°lidos."); return; }

    const name = `${store} ‚Äî ${type}`;
    items.push({ store, type, name, qty, price, tax, cur: base });

    $("itemQty").value = "";
    $("itemPrice").value = "";
    $("itemTax").value = "";

    renderItemsChips();
    saveDraft();
    updateInitialPreview();
  }

  function removeItem(idx){
    items.splice(idx,1);
    renderItemsChips();
    saveDraft();
    updateInitialPreview();
  }

  function renderItemsChips(){
    const wrap = $("itemsChips");
    wrap.innerHTML = "";
    if(items.length === 0){ wrap.innerHTML = `<div class="muted">No has agregado art√≠culos.</div>`; return; }
    items.forEach((it,i)=>{
      const div=document.createElement("div");
      div.className="chip";
      const qtyTxt = it.qty ? ` ‚Ä¢ Cant: ${it.qty}` : "";
      const c = it.cur || ($("baseCurrency")?.value || "USD");
      div.innerHTML = `<b>${escapeHtml(it.name)}</b>${qtyTxt} ‚Ä¢ ${sym(c)}${fmt(it.price)} + ${sym(c)}${fmt(it.tax)} <span class="x" title="Eliminar">‚úï</span>`;
      div.querySelector(".x").addEventListener("click", ()=>removeItem(i));
      wrap.appendChild(div);
    });
  }

  
  function getPreviewTotals(){
    const shippingPct = clamp($("shipping").value, 0, 100);
    const initialPct = clamp($("initial").value, 0, 100);
    const base = $("baseCurrency")?.value || "USD";
    const bcvUsd = Number($("bcv").value || 0);
    const bcvEur = Number($("bcv_eur")?.value || 0);
    const bcvBase = (base === "EUR") ? bcvEur : bcvUsd;

    const itemsCalc = items.map(it=>{
      const subtotal = Number(it.price || 0);
      const tax = Number(it.tax || 0);
      const total = subtotal + tax;
      return { ...it, subtotal, tax, total };
    });

    const totalItemsBase = itemsCalc.reduce((a,b)=>a + b.total, 0);
    const shippingBase = totalItemsBase * (shippingPct / 100);
    const totalBase = totalItemsBase + shippingBase;

    const initialBase = totalBase * (initialPct / 100);
    const initialBs = bcvBase ? initialBase * bcvBase : 0;

    return { base, totalItemsBase, shippingPct, shippingBase, totalBase, initialPct, initialBase, bcvUsd, bcvEur, bcvBase, initialBs };
  }

  
  function updateInitialPreview(){
    const el = $("initialPreview");
    if(!el) return;

    if(items.length === 0){
      el.textContent = "Inicial estimada: ‚Äî";
      return;
    }

    const p = getPreviewTotals();
    const baseTxt = `${fmtMoney(p.initialBase, p.base)}`;
    const bsTxt = p.bcvBase ? ` ‚Ä¢ ${fmt(p.initialBs)} Bs` : "";
    el.textContent = `Inicial estimada (${fmtPct(p.initialPct)}%): ${baseTxt}${bsTxt}`;
  }

    const p = getPreviewTotals();
    const usdTxt = `$${fmt(p.initialUSD)}`;
    const bsTxt = p.bcv ? ` ‚Ä¢ ${fmt(p.initialBs)} Bs` : "";
    el.textContent = `Inicial estimada (${fmtPct(p.initialPct)}%): ${usdTxt}${bsTxt}`;
  }

  
  function calculate(){
    if(items.length === 0){ alert("Agrega al menos un art√≠culo."); return; }
    const store = $("brand").value;
    if(!store){ alert("Selecciona una Tienda antes de calcular."); $("brand").focus(); return; }

    const shippingPct = clamp($("shipping").value, 0, 100);
    const initialPct = clamp($("initial").value, 0, 100);

    const base = $("baseCurrency")?.value || "USD";
    const bcvUsd = Number($("bcv").value || 0);
    const bcvEur = Number($("bcv_eur")?.value || 0);
    const bcvBase = (base === "EUR") ? bcvEur : bcvUsd;

    const itemsCalc = items.map(it=>{
      const cur = it.cur || base; // compat
      const subtotal = Number(it.price || 0);
      const tax = Number(it.tax || 0);
      const total = subtotal + tax;
      return { ...it, cur, subtotal, tax, total };
    });

    const subtotalBase = itemsCalc.reduce((a,b)=>a + b.subtotal, 0);
    const taxesBase = itemsCalc.reduce((a,b)=>a + b.tax, 0);
    const totalItemsBase = itemsCalc.reduce((a,b)=>a + b.total, 0);

    const shippingBase = totalItemsBase * (shippingPct / 100);
    const totalBase = totalItemsBase + shippingBase;

    const initialBase = totalBase * (initialPct / 100);
    const remainingBase = Math.max(0, totalBase - initialBase);

    const totalBs = bcvBase ? totalBase * bcvBase : 0;
    const initialBs = bcvBase ? initialBase * bcvBase : 0;
    const remainingBs = bcvBase ? remainingBase * bcvBase : 0;

    const totalUSD = (bcvUsd && totalBs) ? (totalBs / bcvUsd) : 0;
    const initialUSD = (bcvUsd && initialBs) ? (initialBs / bcvUsd) : 0;
    const remainingUSD = (bcvUsd && remainingBs) ? (remainingBs / bcvUsd) : 0;

    const totalEUR = (bcvEur && totalBs) ? (totalBs / bcvEur) : 0;
    const initialEUR = (bcvEur && initialBs) ? (initialBs / bcvEur) : 0;
    const remainingEUR = (bcvEur && remainingBs) ? (remainingBs / bcvEur) : 0;

    const quote = {
      client:$("client").value.trim(),
      date:$("date").value,
      brand:store,

      baseCurrency: base,
      bcvUsd, bcvEur,

      shippingPct,
      initialPct,

      items:itemsCalc,

      subtotalBase, taxesBase, totalItemsBase, shippingBase, totalBase,
      initialBase, remainingBase,

      totalBs, initialBs, remainingBs,

      totalUSD, initialUSD, remainingUSD,
      totalEUR, initialEUR, remainingEUR
    };

    lastQuote = quote;
    renderResults(quote);

    history.unshift(quote);
    history = history.slice(0, 50);
    localStorage.setItem(STORAGE.history_u, JSON.stringify(history));
    localStorage.setItem(STORAGE.last_quote_u, JSON.stringify(lastQuote));
    renderHistory();
    saveDraft();
  }

  
  function renderResults(q){
    const r = $("results");
    const base = q.baseCurrency || "USD";
    const other = (base === "EUR") ? "USD" : "EUR";
    const otherTotal = (other === "USD") ? q.totalUSD : q.totalEUR;

    const lines = q.items.map(it=>`
      <tr>
        <td><b>${escapeHtml(it.name)}</b><div class="small">${it.qty ? "Cant: " + it.qty : ""}</div></td>
        <td>${sym(base)}${fmt(it.subtotal)}</td>
        <td>${sym(base)}${fmt(it.tax)}</td>
        <td><b>${sym(base)}${fmt(it.total)}</b></td>
      </tr>
    `).join("");

    const pct = Number(q.initialPct ?? (q.totalBase > 0 ? (q.initialBase / q.totalBase) * 100 : DEFAULT_INITIAL_PCT));

    r.innerHTML = `
      <div class="kpis">
        <div class="kpi">
          <div class="t">Total (${base})</div>
          <div class="v">${fmtMoney(q.totalBase, base)}</div>
        </div>

        <div class="kpi">
          <div class="t">Total (Bs)</div>
          <div class="v">${(q.bcvUsd || q.bcvEur) ? fmt(q.totalBs) + " Bs" : "‚Äî"}</div>
        </div>

        <div class="kpi">
          <div class="t">Inicial (%)</div>
          <div class="v">${fmtPct(pct)}%</div>
        </div>

        <div class="kpi">
          <div class="t">Inicial (${base} / Bs)</div>
          <div class="v">${fmtMoney(q.initialBase, base)} ${(q.bcvUsd || q.bcvEur) ? "‚Ä¢ " + fmt(q.initialBs) + " Bs" : ""}</div>
        </div>

        <div class="kpi">
          <div class="t">Restante (${base})</div>
          <div class="v">${fmtMoney(q.remainingBase, base)}</div>
        </div>

        <div class="kpi">
          <div class="t">Restante (Bs)</div>
          <div class="v">${(q.bcvUsd || q.bcvEur) ? fmt(q.remainingBs) + " Bs" : "‚Äî"}</div>
        </div>

        ${otherTotal ? `
          <div class="kpi">
            <div class="t">Equivalente (${other})</div>
            <div class="v">${sym(other)}${fmt(otherTotal)}</div>
          </div>
        ` : ``}
      </div>

      <div class="table-wrap">
        <table class="table" style="min-width:540px;">
          <thead>
            <tr>
              <th>Art√≠culo</th>
              <th>Subtotal</th>
              <th>Impuesto</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${lines}
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px">
        Subtotal: <b>${fmtMoney(q.subtotalBase, base)}</b> ‚Ä¢ Impuestos: <b>${fmtMoney(q.taxesBase, base)}</b> ‚Ä¢
        Total art√≠culos: <b>${fmtMoney(q.totalItemsBase, base)}</b> ‚Ä¢ Env√≠o: <b>${fmtMoney(q.shippingBase, base)}</b>
      </div>
    `;
  }

  function loadHistory(){
    history = parseSafe(localStorage.getItem(STORAGE.history_u) || "[]", []);
    if(!Array.isArray(history)) history = [];
    lastQuote = parseSafe(localStorage.getItem(STORAGE.last_quote_u) || "null", null);
  }

  function renderHistory(){
    const list = $("historyList");
    if(!list) return;
    if(history.length === 0){
      list.innerHTML = `<div class="muted">Sin historial.</div>`;
      return;
    }

    list.innerHTML = "";
    history.forEach((q, idx)=>{
      const div = document.createElement("div");
      div.className = "hist";

      div.innerHTML = `
        <div class="hist-top">
          <div>
            <b>${escapeHtml(q.client || "‚Äî")}</b>
            <div class="meta">${escapeHtml(q.brand || "‚Äî")} ‚Ä¢ ${escapeHtml(q.date || "‚Äî")}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900;">$${fmt(q.totalUSD)}</div>
            <div class="meta">${q.bcv ? fmt(q.totalBs) + " Bs" : ""}</div>
          </div>
        </div>

        <div class="hist-actions">
          <button data-act="load">üì• Cargar</button>
          <button data-act="pdf">üìÑ PDF</button>
          <button data-act="wa">üì≤ WhatsApp</button>
          <button class="del" data-act="del">üóëÔ∏è Eliminar</button>
        </div>
      `;

      div.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if(act==="load") loadFromHistory(idx);
          if(act==="pdf") exportPDF(history[idx]);
          if(act==="wa") shareWhatsApp(history[idx]);
          if(act==="del") deleteFromHistory(idx);
        });
      });

      list.appendChild(div);
    });
  }

  function loadFromHistory(index){
    const q = history[index];
    if(!q) return;

    $("client").value = q.client ?? "";
    $("date").value = q.date ?? nowISODate();
    $("brand").value = q.brand ?? "";

    if($("baseCurrency")) $("baseCurrency").value = q.baseCurrency ?? "USD";
    if($("bcv_eur")) $("bcv_eur").value = (q.bcvEur ?? q.bcv_eur ?? "");
    $("shipping").value = q.shippingPct ?? "";

    if(q.initialPct != null){
      $("initial").value = q.initialPct;
    }else{
      const t = (q.totalBase ?? q.totalUSD ?? 0);
      const ini = (q.initialBase ?? q.initialUSD ?? 0);
      const inferred = t > 0 ? (ini / t) * 100 : DEFAULT_INITIAL_PCT;
      $("initial").value = String(Math.round(inferred * 100) / 100);
    }

    $("bcv").value = (q.bcvUsd ?? q.bcv ?? "");
    items = Array.isArray(q.items) ? [...q.items] : [];
    renderItemsChips();

    lastQuote = q;
    localStorage.setItem(STORAGE.last_quote_u, JSON.stringify(lastQuote));
    renderResults(q);
    saveDraft();
    updateAddBtn();
    updateInitialPreview();
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function deleteFromHistory(index){
    if(!confirm("¬øEliminar esta cotizaci√≥n del historial?")) return;
    history.splice(index, 1);
    localStorage.setItem(STORAGE.history_u, JSON.stringify(history));
    renderHistory();
  }

  function clearHistory(){
    if(!confirm("¬øBorrar TODO el historial?")) return;
    history = [];
    localStorage.removeItem(STORAGE.history_u);
    renderHistory();
  }

  // Payments + Terms
  const DEFAULT_TERMS_LINES = [
    "No se realizan devoluciones",
    "La mercanc√≠a se paga con inicial para procesar el pedido",
    "Tiempo estimado de entrega sujeto a la tienda"
  ];
  let payments = { bs:"", usd:"", cop:"", usdt:"" };
  let termsText = "";

  function loadPayments(){
    payments = parseSafe(localStorage.getItem(STORAGE.payments_u) || "null", null) || payments;
  }
  function savePayments(){
    localStorage.setItem(STORAGE.payments_u, JSON.stringify(payments));
  }
  function applyPaymentsToUI(){
    if($("pay_bs")) $("pay_bs").value = payments.bs || "";
    if($("pay_usd")) $("pay_usd").value = payments.usd || "";
    if($("pay_cop")) $("pay_cop").value = payments.cop || "";
    if($("pay_usdt")) $("pay_usdt").value = payments.usdt || "";
  }
  function readPaymentsFromUI(){
    payments.bs = $("pay_bs")?.value || "";
    payments.usd = $("pay_usd")?.value || "";
    payments.cop = $("pay_cop")?.value || "";
    payments.usdt = $("pay_usdt")?.value || "";
    savePayments();
  }

  function loadTerms(){
    termsText = localStorage.getItem(STORAGE.terms_u) || "";
  }
  function saveTerms(){
    localStorage.setItem(STORAGE.terms_u, termsText || "");
  }
  function applyTermsToUI(){
    if($("terms_text")) $("terms_text").value = termsText || "";
  }
  function readTermsFromUI(){
    termsText = $("terms_text")?.value || "";
    saveTerms();
  }

  function formatTermsForWA(text){
    const lines = String(text || "").split("\n").map(s=>s.trim()).filter(Boolean);
    const use = lines.length ? lines : DEFAULT_TERMS_LINES;
    return use.map(l=>`‚Ä¢ ${l}`).join("\n");
  }

  
  function quoteToMessage(q){
    const dt = nowDateTimeVE();
    const base = q.baseCurrency || "USD";
    const other = (base === "EUR") ? "USD" : "EUR";
    const otherTotal = (other === "USD") ? q.totalUSD : q.totalEUR;

    const itemsLines = q.items.map((it, i)=>{
      const qty = it.qty ? ` ‚Ä¢ Cant: ${it.qty}` : "";
      return `${i+1}) ${it.name}${qty}\n   - Precio: ${sym(base)}${fmt(it.subtotal)} | Imp: ${sym(base)}${fmt(it.tax)} | Total: ${sym(base)}${fmt(it.total)}`;
    }).join("\n");

    const totalBase = q.totalBase;
    const inicialBase = q.initialBase;
    const restanteBase = q.remainingBase;

    const initialPct = Number(q.initialPct ?? (totalBase > 0 ? (inicialBase / totalBase) * 100 : DEFAULT_INITIAL_PCT));

    const tasaBase = (base === "EUR") ? q.bcvEur : q.bcvUsd;

    const payBS = (payments.bs || "").trim();
    const payUSD = (payments.usd || "").trim();
    const payCOP = (payments.cop || "").trim();
    const payUSDT = (payments.usdt || "").trim();

    const termsBlock = formatTermsForWA(termsText || DEFAULT_TERMS_LINES);

    return [
`üßæ *COTIZACI√ìN*
üè∑Ô∏è Tienda: *${q.brand || "‚Äî"}*
üë§ Cliente: *${q.client || "‚Äî"}*
üìÖ Fecha: ${q.date || "‚Äî"}`,

`üì¶ *DETALLE DE ART√çCULOS*
${itemsLines}`,

`üí∞ *RESUMEN*
Subtotal: ${fmtMoney(q.subtotalBase, base)}
Impuestos: ${fmtMoney(q.taxesBase, base)}
Total art√≠culos: ${fmtMoney(q.totalItemsBase, base)}
Env√≠o (${fmtPct(q.shippingPct)}%): ${fmtMoney(q.shippingBase, base)}

‚úÖ *TOTAL A PAGAR: ${fmtMoney(totalBase, base)}*
üí≥ Inicial (${fmtPct(initialPct)}%): ${fmtMoney(inicialBase, base)}
üßæ Restante: ${fmtMoney(restanteBase, base)}${otherTotal ? `\nüîÅ Equivalente ${other}: ${sym(other)}${fmt(otherTotal)}` : ""}`,

`üí± *TASA*
${base}‚ÜíVES: ${tasaBase ? fmt(tasaBase) + " Bs" : "‚Äî"}`,

`üí≥ *M√âTODOS DE PAGO*
Bs: ${payBS || "‚Äî"}
USD: ${payUSD || "‚Äî"}
COP: ${payCOP || "‚Äî"}
USDT: ${payUSDT || "‚Äî"}`,

`üìå *T√âRMINOS Y CONDICIONES*
${termsBlock}`,

`üïí Generado: ${dt}`
    ].join("\n\n");
  }

  function shareWhatsApp(q){
    if(!q) { alert("No hay cotizaci√≥n para enviar."); return; }
    readPaymentsFromUI();
    readTermsFromUI();
    const msg = quoteToMessage(q);
    const url = "https://wa.me/?text=" + encodeURIComponent(msg);
    window.open(url, "_blank");
  }

  // PDF
  function exportPDF(q){
    if(!q){ alert("No hay cotizaci√≥n para exportar."); return; }
    readPaymentsFromUI();
    readTermsFromUI();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let y = 14;
    const lh = 7;

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text("COTIZACI√ìN - Cotizador Pro", 14, y); y += lh;

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Cliente: ${q.client || "‚Äî"}`, 14, y); y += lh;
    doc.text(`Tienda: ${q.brand || "‚Äî"}`, 14, y); y += lh;
    doc.text(`Fecha: ${q.date || "‚Äî"}`, 14, y); y += lh;
    doc.text(`Tasa (USD‚ÜíVES): ${q.bcv ? fmt(q.bcv) + " Bs" : "‚Äî"}`, 14, y); y += lh;

    y += 4;
    doc.setFont("helvetica","bold");
    doc.text("Detalle de art√≠culos:", 14, y); y += lh;

    doc.setFont("helvetica","normal");
    q.items.forEach((it, idx)=>{
      const qty = it.qty ? ` Cant: ${it.qty}` : "";
      const line = `${idx+1}) ${it.name}${qty} | Subtotal: $${fmt(it.subtotal)} | Imp: $${fmt(it.tax)} | Total: $${fmt(it.total)}`;
      doc.text(line, 14, y);
      y += lh;
      if(y > 275){ doc.addPage(); y = 14; }
    });

    y += 4;
    doc.setFont("helvetica","bold");
    doc.text("Resumen:", 14, y); y += lh;

    doc.setFont("helvetica","normal");
    doc.text(`Subtotal: $${fmt(q.subtotalUSD)}`, 14, y); y += lh;
    doc.text(`Impuestos: $${fmt(q.taxesUSD)}`, 14, y); y += lh;
    doc.text(`Total art√≠culos: $${fmt(q.totalItemsUSD)}`, 14, y); y += lh;
    doc.text(`Env√≠o (${fmtPct(q.shippingPct)}%): $${fmt(q.shippingUSD)}`, 14, y); y += lh;

    doc.setFont("helvetica","bold");
    doc.text(`TOTAL: $${fmt(q.totalUSD)}`, 14, y); y += lh;

    doc.setFont("helvetica","normal");
    doc.text(`Inicial ($): $${fmt(q.initialUSD)} | Restante ($): $${fmt(q.remainingUSD)}`, 14, y); y += lh;

    if(q.bcv){
      doc.text(`Total (Bs): ${fmt(q.totalBs)} Bs`, 14, y); y += lh;
      doc.text(`Inicial (Bs): ${fmt(q.initialBs)} Bs | Restante (Bs): ${fmt(q.remainingBs)} Bs`, 14, y); y += lh;
    }

    y += 4;
    doc.setFont("helvetica","bold");
    doc.text("M√©todos de pago:", 14, y); y += lh;
    doc.setFont("helvetica","normal");
    doc.text(`Bs: ${payments.bs || "‚Äî"}`, 14, y); y += lh;
    doc.text(`USD: ${payments.usd || "‚Äî"}`, 14, y); y += lh;
    doc.text(`COP: ${payments.cop || "‚Äî"}`, 14, y); y += lh;
    doc.text(`USDT: ${payments.usdt || "‚Äî"}`, 14, y); y += lh;

    y += 4;
    doc.setFont("helvetica","bold");
    doc.text("T√©rminos:", 14, y); y += lh;
    doc.setFont("helvetica","normal");
    const termsLines = (termsText || "").split("\n").map(s=>s.trim()).filter(Boolean);
    const useTerms = termsLines.length ? termsLines : DEFAULT_TERMS_LINES;
    useTerms.forEach(t=>{
      doc.text("‚Ä¢ " + t, 14, y);
      y += lh;
      if(y > 275){ doc.addPage(); y = 14; }
    });

    const fname = `Cotizacion_${(q.client||"Cliente").replace(/\s+/g,"_")}_${q.date||""}.pdf`;
    doc.save(fname);
  }

  // Mini calculators
  function m1(op){
    const a = Number($("m1a").value || 0);
    const b = Number($("m1b").value || 0);
    let r = 0;
    if(op === "+") r = a + b;
    if(op === "-") r = a - b;
    if(op === "*") r = a * b;
    $("m1out").textContent = fmt(r);
  }

  function m2(op){
    const a = Number($("m2a").value || 0);
    const b = Number($("m2b").value || 0);
    const rate = Number($("bcv").value || 0);
    if(!rate || rate <= 0){
      $("m2out").textContent = "Coloca la Tasa BCV para convertir.";
      return;
    }

    let bs = 0;
    if(op === "+") bs = a + b;
    if(op === "-") bs = a - b;
    if(op === "*") bs = a * b;

    const usd = bs / rate;
    $("m2out").textContent = "$" + fmt(usd);
  }

  // Cambiar mi contrase√±a
  function setPwMsg(t){
    const el = $("pw_msg");
    if(el) el.textContent = t;
  }

  // Gesti√≥n de usuarios (superadmin)
  function normalizeUserId(s){
    return String(s||"").trim().replace(/\s+/g,"").replace(/[^a-zA-Z0-9_-]/g,"");
  }
  function setUserMsg(t){
    const el = $("nu_msg");
    if(el) el.textContent = t;
  }

  function exportUsersPayload(){
    const custom = loadUserStore() || {};
    const passStore = loadPassStore() || {};
    return { version:2, exportedAt: new Date().toISOString(), custom, passStore };
  }

  function importUsersPayload(txt, { merge=true }={}){
    const payload = JSON.parse(txt);
    if(!payload || typeof payload !== "object") throw new Error("JSON inv√°lido.");
    const custom = payload.custom || {};
    const passStore = payload.passStore || {};
    if(merge){
      const curC = loadUserStore() || {};
      const curP = loadPassStore() || {};
      saveUserStore(Object.assign(curC, custom));
      savePassStore(Object.assign(curP, passStore));
    }else{
      saveUserStore(custom);
      savePassStore(passStore);
    }
  }

  function initUserManagementUI(){
    const active = getActiveUser();
    const USERS = getUsers();
    const role = USERS?.[active]?.role || "admin";

    // Solo superadmin ve reset/export/import/create/del
    const isSuper = role === "superadmin";
    ["nu_add","nu_refresh","nu_reset_all","ex_users","ex_copy","im_users","im_replace","users_json"].forEach(id=>{
      const el = $(id);
      if(el) el.closest(".mini")?.classList.toggle("admin-only", true);
      if(el && !isSuper){
        // no ocultamos el contenedor entero para no romper UI,
        // pero deshabilitamos acciones sensibles
        if(el.tagName === "BUTTON" || el.tagName === "TEXTAREA" || el.tagName === "INPUT" || el.tagName === "SELECT"){
          el.disabled = true;
        }
      }
    });

    function renderUsersTable(){
      const tbody = $("usersTableBody");
      if(!tbody) return;

      const USERS2 = getUsers();
      const active2 = getActiveUser();
      const ROLE2 = USERS2[active2]?.role || "admin";

      const rows = Object.keys(USERS2).sort().map(u=>{
        const info = USERS2[u];
        const isDefault = !!DEFAULT_USERS[u];
        const canDelete = (ROLE2 === "superadmin") && !isDefault;

        return `
          <tr>
            <td><b>${escapeHtml(u)}</b></td>
            <td>${escapeHtml(info.name || "")}</td>
            <td>${info.role === "superadmin" ? "Admin Maestro" : "Admin"}</td>
            <td>
              ${canDelete ? `<button data-del="${escapeHtml(u)}" style="padding:8px 10px;border-radius:12px;border:1px solid var(--line);cursor:pointer;background:color-mix(in srgb, #ef4444 12%, var(--card));font-weight:900;">Eliminar</button>` : `<span class="small">‚Äî</span>`}
            </td>
          </tr>
        `;
      }).join("");

      tbody.innerHTML = rows || `<tr><td colspan="4" class="muted">‚Äî</td></tr>`;

      tbody.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const userId = btn.getAttribute("data-del");
          if(!userId) return;
          if(!confirm(`¬øEliminar usuario "${userId}"?`)) return;

          const custom = loadUserStore() || {};
          const passStore = loadPassStore() || {};
          delete custom[userId];
          delete passStore[userId];
          saveUserStore(custom);
          savePassStore(passStore);

          setUserMsg("‚úÖ Usuario eliminado.");
          buildLoginOptions();
          renderUsersTable();
        });
      });
    }

    if($("nu_refresh")){
      $("nu_refresh").onclick = ()=>{
        renderUsersTable();
        setUserMsg("üîÑ Lista actualizada.");
      };
    }

    if($("nu_add")){
      $("nu_add").onclick = ()=>{
        try{
          const active2 = getActiveUser();
          const USERS2 = getUsers();
          const ROLE2 = USERS2[active2]?.role || "admin";
          if(ROLE2 !== "superadmin"){
            setUserMsg("‚õî Solo el Admin Maestro puede crear usuarios.");
            return;
          }

          const id = normalizeUserId($("nu_user").value);
          const name = ($("nu_name").value || "").trim() || id;
          const pass = ($("nu_pass").value || "").trim();
          const roleNew = $("nu_role").value || "admin";

          if(!id){ setUserMsg("‚ö†Ô∏è Coloca un ID de usuario."); return; }
          if(pass.length < 4){ setUserMsg("‚ö†Ô∏è Contrase√±a m√≠nima 4 caracteres."); return; }

          const custom = loadUserStore() || {};
          const passStore = loadPassStore() || {};

          if(DEFAULT_USERS[id] || custom[id]){
            setUserMsg("‚ö†Ô∏è Ese usuario ya existe.");
            return;
          }

          custom[id] = { name, role: roleNew, avatar: makeAvatarFromUser(id) };
          passStore[id] = pass;

          saveUserStore(custom);
          savePassStore(passStore);

          $("nu_user").value = "";
          $("nu_name").value = "";
          $("nu_pass").value = "";

          setUserMsg("‚úÖ Usuario creado.");
          buildLoginOptions();
          renderUsersTable();
        }catch(e){
          setUserMsg("‚ùå Error: " + (e?.message || e));
        }
      };
    }

    if($("nu_reset_all")){
      $("nu_reset_all").onclick = ()=>{
        const active2 = getActiveUser();
        const USERS2 = getUsers();
        const ROLE2 = USERS2[active2]?.role || "admin";
        if(ROLE2 !== "superadmin"){
          setUserMsg("‚õî Solo el Admin Maestro puede resetear usuarios.");
          return;
        }
        if(!confirm("¬øSeguro? Esto elimina usuarios creados y resetea contrase√±as guardadas.")) return;

        localStorage.removeItem(USER_STORE_KEY);
        localStorage.removeItem(PASS_STORE_KEY);
        localStorage.removeItem(LOCK_STORE_KEY);
        localStorage.removeItem(ACTIVE_USER_KEY);

        try{ $("users_json").value = ""; }catch(_){}
        buildLoginOptions();
        renderUsersTable();

        alert("‚úÖ Reset listo. Vuelve a iniciar sesi√≥n.");
        location.reload();
      };
    }

    function setXMsg(t){
      const el = $("users_xmsg");
      if(el) el.textContent = t;
    }

    if($("ex_users")){
      $("ex_users").onclick = ()=>{
        try{
          const payload = exportUsersPayload();
          $("users_json").value = JSON.stringify(payload, null, 2);
          setXMsg("‚úÖ Exportado. Copia y p√©galo en el otro dispositivo.");
        }catch(e){
          setXMsg("‚ùå Error exportando: " + (e?.message || e));
        }
      };
    }

    if($("ex_copy")){
      $("ex_copy").onclick = async ()=>{
        try{
          const txt = $("users_json").value.trim();
          if(!txt){ setXMsg("‚ö†Ô∏è Primero exporta para generar el JSON."); return; }
          await navigator.clipboard.writeText(txt);
          setXMsg("üìã Copiado al portapapeles.");
        }catch(e){
          setXMsg("‚ùå No pude copiar. Copia manualmente el texto.");
        }
      };
    }

    if($("im_users")){
      $("im_users").onclick = ()=>{
        try{
          const txt = $("users_json").value.trim();
          if(!txt){ setXMsg("‚ö†Ô∏è Pega el JSON primero."); return; }
          importUsersPayload(txt, { merge:true });
          setXMsg("‚úÖ Importaci√≥n completada (mezclado).");
          buildLoginOptions();
          renderUsersTable();
        }catch(e){
          setXMsg("‚ùå Error importando: " + (e?.message || e));
        }
      };
    }

    if($("im_replace")){
      $("im_replace").onclick = ()=>{
        try{
          const txt = $("users_json").value.trim();
          if(!txt){ setXMsg("‚ö†Ô∏è Pega el JSON primero."); return; }
          if(!confirm("¬øSeguro? Esto REEMPLAZA los usuarios creados en este dispositivo.")) return;
          importUsersPayload(txt, { merge:false });
          setXMsg("‚úÖ Importaci√≥n completada (reemplazado).");
          buildLoginOptions();
          renderUsersTable();
        }catch(e){
          setXMsg("‚ùå Error importando: " + (e?.message || e));
        }
      };
    }

    renderUsersTable();
  }

  function init(){

applyTheme();

// En m√≥vil: cerrar "Detalles" por defecto para que no ocupe media pantalla
const det = document.getElementById("calcDetails");
if(det && window.matchMedia("(max-width: 768px)").matches){
  det.removeAttribute("open");
}
    updateActiveUserBadge();
    initStorageKeys();

    const active = getActiveUser();
    if(!active){
      showLogin();
      return;
    }

    resetInactivityTimer();

    // Datos iniciales
    buildLoginOptions();

    loadDraft();
    if($("rateStateUsd")) $("rateStateUsd").textContent = ($("bcv")?.value ? "Manual" : "Manual");
    if($("rateStateEur")) $("rateStateEur").textContent = ($("bcv_eur")?.value ? "Manual" : "Manual");
    loadHistory();
    loadPayments();
    loadTerms();
    applyPaymentsToUI();
    applyTermsToUI();
    ensureDefaultInitialPct();
    refreshCurrencyUI();
    renderHistory();
    renderItemsChips();
    updateAddBtn();
    updateInitialPreview();

    const savedMode = localStorage.getItem(STORAGE.mode_u);
    if(savedMode === "client"){
      if(!lastQuote && history.length > 0) lastQuote = history[0];
      if(lastQuote) localStorage.setItem(STORAGE.last_quote_u, JSON.stringify(lastQuote));
      setClientMode(true);
      if(lastQuote) renderResults(lastQuote);
    }else{
      $("modeBadge").textContent = "Admin";
      document.body.classList.remove("client");
    }

    updateRate({ force: false });
    updatePrivateToggleText();
    initUserManagementUI();
  }

  /* ===========================
     EVENTS
  =========================== */
  on("loginBtn","click", doLogin);
  on("loginClearBtn","click", ()=>{
    if($("loginPass")){ $("loginPass").value = ""; $("loginPass").focus(); }
  });
  on("loginPass","keydown", (e)=>{ if(e.key === "Enter") doLogin(); });
  on("loginUser","change", updateLoginPreview);
  on("logoutBtn","click", doLogout);

  on("themeToggle","click", toggleTheme);

  on("clientModeBtn","click", ()=>{
    const onNow = document.body.classList.contains("client");
    setClientMode(!onNow);
  });

  on("privateDetails","toggle", updatePrivateToggleText);
  on("privateToggleBtn","click", (e)=>{
    e.preventDefault();
    const det = $("privateDetails");
    det.open = !det.open;
    updatePrivateToggleText();
  });

  on("brand","change", ()=>{ updateAddBtn(); saveDraft(); });

  on("addItemBtn","click", addItem);

  on("shipping","input", ()=>{ saveDraft(); updateInitialPreview(); });
  on("initial","input", ()=>{ saveDraft(); updateInitialPreview(); });
  on("bcv","input", ()=>{ saveDraft(); updateInitialPreview(); });

  on("calcBtn","click", calculate);
  on("resetBtn","click", ()=>{
    if(!confirm("¬øReiniciar cotizaci√≥n actual?")) return;
    items = [];
    lastQuote = null;
    $("client").value = "";
    $("brand").value = "";
    $("bcv").value = "";
    $("shipping").value = "";
    $("initial").value = "";
    $("date").value = nowISODate();
    localStorage.removeItem(STORAGE.draft_u);
    localStorage.removeItem(STORAGE.last_quote_u);
    $("results").innerHTML = `<div class="muted">Sin cotizaci√≥n todav√≠a.</div>`;
    renderItemsChips();
    updateAddBtn();
    updateInitialPreview();
  });

  on("clearHistoryBtn","click", clearHistory);

  on("pdfBtn","click", ()=>exportPDF(lastQuote));
  on("waBtn","click", ()=>shareWhatsApp(lastQuote));

  // Payments & terms autosave
  ["pay_bs","pay_usd","pay_cop","pay_usdt"].forEach(id=>{
    on(id,"input", readPaymentsFromUI);
  });
  on("terms_text","input", readTermsFromUI);

  // Mini calcs
  if($("m1plus")) $("m1plus").onclick = ()=>m1("+");
  if($("m1minus")) $("m1minus").onclick = ()=>m1("-");
  if($("m1mul")) $("m1mul").onclick = ()=>m1("*");

  if($("m2plus")) $("m2plus").onclick = ()=>m2("+");
  if($("m2minus")) $("m2minus").onclick = ()=>m2("-");
  if($("m2mul")) $("m2mul").onclick = ()=>m2("*");

  if($("rateBtn")) $("rateBtn").onclick = ()=>updateRate({force:true});


  if($("rateEurBtn")) $("rateEurBtn").onclick = ()=>updateRateEUR({force:true});

  on("bcv","input", ()=>{
    if($("rateStateUsd")) $("rateStateUsd").textContent = "Manual";
    saveDraft();
    updateInitialPreview();
  });
  on("bcv_eur","input", ()=>{
    if($("rateStateEur")) $("rateStateEur").textContent = "Manual";
    saveDraft();
    updateInitialPreview();
  });
  on("baseCurrency","change", ()=>{
    refreshCurrencyUI();
    saveDraft();
    updateInitialPreview();
  });

  // Cambiar mi contrase√±a
  if($("pw_save")){
    
$("pw_save").onclick = async ()=>{
      const USERS_NOW = getUsers();
      const u = getActiveUser();
      if(!u || !USERS_NOW[u]) return;

      const cur = ($("pw_current").value || "").trim();
      const n1  = ($("pw_new").value || "").trim();
      const n2  = ($("pw_new2").value || "").trim();

      const okCur = await verifyAndMaybeMigratePassword(u, cur);
      if(!okCur){
        setPwMsg("‚ùå La contrase√±a actual no coincide.");
        return;
      }
      if(n1.length < 4){
        setPwMsg("‚ö†Ô∏è La nueva contrase√±a debe tener al menos 4 caracteres.");
        return;
      }
      if(n1 !== n2){
        setPwMsg("‚ö†Ô∏è La confirmaci√≥n no coincide.");
        return;
      }

      // Guardar NUEVA contrase√±a en hash (recomendado)
      try{
        const hs = loadPassHashStore();
        const salt = makeSaltB64();
        const hash = await pbkdf2Hash(n1, salt, 200000);
        hs[u] = { salt, hash, it: 200000 };
        savePassHashStore(hs);

        // limpiar legacy plain
        const passStore = loadPassStore();
        if(passStore && passStore[u]){
          delete passStore[u];
          savePassStore(passStore);
        }

        // limpiar campos
        $("pw_current").value = "";
        $("pw_new").value = "";
        $("pw_new2").value = "";
        setPwMsg("‚úÖ Contrase√±a actualizada (encriptada).");
      }catch(e){
        console.error(e);
        setPwMsg("‚ö†Ô∏è No se pudo encriptar en este navegador. Intenta actualizar iOS/Safari.");
      }
    };
  }

  // Init with safety net
  try{
    init();
  }catch(err){
    console.error(err);
    try{
      alert("‚ùå Ocurri√≥ un error al iniciar.\n\nRevisa consola para detalles.\n\nSi el error fue por usuarios/almacenamiento, se cerrar√° sesi√≥n.");
    }catch(_){}
    try{
      localStorage.removeItem(ACTIVE_USER_KEY);
      showLogin();
    }catch(_){}
  }

})();
</script>

<script>
// ===== PWA: Service Worker (requiere sw.js en la misma carpeta) =====
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(err=>console.warn("SW:", err));
  });
}
</script>
<script>
/* ===== TELEGRAM NOTIFICACIONES ===== */
const TG_TOKEN = "8001046312:AAFbQhUz3z4w761XnpUthcCZAHWROCg0bzE";
const TG_CHAT_ID = "8020943630";

function detectarDispositivo(){
  const ua = navigator.userAgent;
  if(/android/i.test(ua)) return "Android";
  if(/iPhone|iPad|iPod/i.test(ua)) return "iOS";
  if(/Win/i.test(ua)) return "Windows";
  if(/Mac/i.test(ua)) return "Mac";
  return "Desconocido";
}

function enviarNotificacion(tipo, usuario="Sin sesi√≥n"){
  const fecha = new Date().toLocaleString();
  const dispositivo = detectarDispositivo();

  const mensaje =
`üì≤ ${tipo}
üë§ Usuario: ${usuario}
üïí Fecha: ${fecha}
üíª Dispositivo: ${dispositivo}`;

  fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chat_id: TG_CHAT_ID, text: mensaje })
  }).catch(()=>{});
}

/* Notificar cuando abren la app */
window.addEventListener("load", ()=>{
  const usuarioActivo = localStorage.getItem("activeUser") || "Sin sesi√≥n";
  enviarNotificacion("Apertura detectada", usuarioActivo);
});
</script>
</body>
</html>

